<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Specify IPT integration | MELISR documentation</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/melisr-docs-vuepress/assets/css/0.styles.4e056352.css" as="style"><link rel="preload" href="/melisr-docs-vuepress/assets/js/app.ed396d9f.js" as="script"><link rel="preload" href="/melisr-docs-vuepress/assets/js/3.08a0837d.js" as="script"><link rel="preload" href="/melisr-docs-vuepress/assets/js/32.aef22f61.js" as="script"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/10.5ae15643.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/11.1adacd3d.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/12.587868a1.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/13.ac7bcf09.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/14.02675d19.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/15.40e7bd7e.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/16.07b41535.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/17.23e92267.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/18.42e0d9d6.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/19.5dd49a63.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/2.c6acca67.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/20.22f6b089.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/21.9881b452.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/22.503b342f.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/23.fae0bb15.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/24.3b18ed35.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/25.1dd8e852.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/26.e6e89cf6.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/27.12b6fdb0.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/28.8788af6a.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/29.8c4a54b9.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/30.8e54ddc7.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/31.d48320b5.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/33.43d76f8d.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/34.c625cab3.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/35.8632b307.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/36.1d0b34c3.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/37.6faa5075.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/38.7311e6ab.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/4.b5565ff5.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/5.3e537086.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/6.211bd2e1.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/7.56738cb3.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/8.a906b5fb.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/9.f1f1474a.js">
    <link rel="stylesheet" href="/melisr-docs-vuepress/assets/css/0.styles.4e056352.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/melisr-docs-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">MELISR documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/melisr-docs-vuepress/data-entry-manual/" class="nav-link">Data entry manual</a></div><div class="nav-item"><a href="/melisr-docs-vuepress/additional-documents/" class="nav-link router-link-active">Additional documents</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/melisr-docs-vuepress/data-entry-manual/" class="nav-link">Data entry manual</a></div><div class="nav-item"><a href="/melisr-docs-vuepress/additional-documents/" class="nav-link router-link-active">Additional documents</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/melisr-docs-vuepress/additional-documents/melisr-fields-in-avh/" class="sidebar-link">MELISR fields in AVH</a></li><li><a href="/melisr-docs-vuepress/additional-documents/herbarium-interactions/" class="sidebar-link">Herbarium interactions</a></li><li><a href="/melisr-docs-vuepress/additional-documents/business-case/" class="sidebar-link">Business case (2009)</a></li><li><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/" class="sidebar-link">Specify to Darwin Core mapping</a></li><li><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/" class="active sidebar-link">Specify IPT integration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#extra-functions" class="sidebar-link">Extra functions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#collectorstring" class="sidebar-link">collectorstring()</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#recorded-by-id" class="sidebar-link">recordedbyid()</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#preparations" class="sidebar-link">preparations()</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#associated-sequences" class="sidebar-link">associated_sequences()</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#previous-identifications" class="sidebar-link">previous_identifications()</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#identification-string" class="sidebar-link">identification_string()</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#identified-by-id" class="sidebar-link">identifiedbyid()</a></li></ul></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#denormalise-trees" class="sidebar-link">Denormalise trees</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#taxon-tree" class="sidebar-link">Taxon tree</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/#geography-tree" class="sidebar-link">Geography tree</a></li></ul></li></ul></li><li><a href="/melisr-docs-vuepress/additional-documents/people-in-specify/" class="sidebar-link">People and people identifiers in Specify</a></li><li><a href="/melisr-docs-vuepress/additional-documents/qa-tests/" class="sidebar-link">Quality assurance tests</a></li><li><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration-pt2/" class="sidebar-link">Specify IPT integration – Part 2</a></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="specify-ipt-integration"><a href="#specify-ipt-integration" aria-hidden="true" class="header-anchor">#</a> Specify IPT integration</h1> <p>After setting up the Schema Mapper and running the Data Exporter (see
<a href="../specify-dwc-mapping">Specify to Darwin Core mapping</a>), I found out
that the command line tool to update the exported data, ExpCmdLine,
requires a graphics card, which makes that I cannot run it from the server and
use it to schedule updates. Therefore, inspired by Andy's presentation of the
DwCA tool in Specify 7, I decided to try and write an SQL query that I could use
directly in the IPT. This worked after a bit of trial and error.</p> <p>This is the rather impressive-looking (if I may say so myself) query I came up
with.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> 
  co<span class="token punctuation">.</span>CollectionObjectID <span class="token keyword">as</span> id<span class="token punctuation">,</span> 
  co<span class="token punctuation">.</span>GUID <span class="token keyword">as</span> occurrenceID<span class="token punctuation">,</span>
  
  <span class="token comment">-- record level terms</span>
  <span class="token string">'PhysicalObject'</span> <span class="token keyword">as</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span>
  co<span class="token punctuation">.</span>TimestampModified <span class="token keyword">as</span> modified<span class="token punctuation">,</span>
  <span class="token string">'https://creativecommons.org/licenses/by/4.0/legalcode'</span> <span class="token keyword">AS</span> license<span class="token punctuation">,</span>
  <span class="token string">'Royal Botanic Gardens Board'</span> <span class="token keyword">AS</span> rightsHolder<span class="token punctuation">,</span>
  <span class="token string">'MEL'</span> <span class="token keyword">as</span> institutionCode<span class="token punctuation">,</span>
  <span class="token string">'MEL'</span> <span class="token keyword">as</span> collectionCode<span class="token punctuation">,</span>
  <span class="token string">'PreservedSpecimen'</span> <span class="token keyword">as</span> basisOfRecord<span class="token punctuation">,</span>
  
  <span class="token comment">-- Occurrence</span>
  concat<span class="token punctuation">(</span><span class="token string">'MEL '</span><span class="token punctuation">,</span> co<span class="token punctuation">.</span>CatalogNumber<span class="token punctuation">)</span> <span class="token keyword">as</span> catalogNumber<span class="token punctuation">,</span>
  ce<span class="token punctuation">.</span>VerbatimLocality <span class="token keyword">as</span> occurrenceRemarks<span class="token punctuation">,</span>
  ce<span class="token punctuation">.</span>StationFieldNumber <span class="token keyword">as</span> recordNumber<span class="token punctuation">,</span>
  collectorstring<span class="token punctuation">(</span>ce<span class="token punctuation">.</span>CollectingEventID<span class="token punctuation">,</span> <span class="token string">'|'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">as</span> recordedBy<span class="token punctuation">,</span>
  recorded_by_id<span class="token punctuation">(</span>ce<span class="token punctuation">.</span>CollectingEventID<span class="token punctuation">)</span> <span class="token keyword">as</span> recordedByID<span class="token punctuation">,</span>
  dwc_reproductive_condition<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span> <span class="token keyword">as</span> reproductiveCondition<span class="token punctuation">,</span>
  dwc_establishment_means<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span> <span class="token keyword">as</span> establishmentMeans<span class="token punctuation">,</span>
  <span class="token string">'present'</span> <span class="token keyword">as</span> occurrenceStatus<span class="token punctuation">,</span>
  preparations<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span> <span class="token keyword">as</span> preparations<span class="token punctuation">,</span>
  associated_sequences<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span> <span class="token keyword">as</span> associatedSequences<span class="token punctuation">,</span>
  <span class="token comment">-- associatedTaxa,</span>
  
  <span class="token comment">-- Organism</span>
  previous_identifications<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span> previousIdentifications<span class="token punctuation">,</span>
  
  <span class="token comment">-- Event</span>
  ce<span class="token punctuation">.</span>GUID <span class="token keyword">as</span> eventID<span class="token punctuation">,</span>
  ctr<span class="token punctuation">.</span>CollectingTripName <span class="token keyword">as</span> parentEventID<span class="token punctuation">,</span>
  concat_ws<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> dateWithPrecision<span class="token punctuation">(</span>ce<span class="token punctuation">.</span>StartDate<span class="token punctuation">,</span> ce<span class="token punctuation">.</span>StartDatePrecision<span class="token punctuation">)</span><span class="token punctuation">,</span> dateWithPrecision<span class="token punctuation">(</span>ce<span class="token punctuation">.</span>EndDate<span class="token punctuation">,</span> ce<span class="token punctuation">.</span>EndDatePrecision<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> eventDate<span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>EndDate <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> ce<span class="token punctuation">.</span>StartDatePrecision<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dayofyear<span class="token punctuation">(</span>ce<span class="token punctuation">.</span>StartDate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> startDayOfYear<span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>EndDate <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token keyword">year</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>StartDate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">&quot;year&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>EndDate <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> ce<span class="token punctuation">.</span>StartDatePrecision <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">month</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>StartDate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">&quot;month&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>EndDate <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> ce<span class="token punctuation">.</span>StartDatePrecision<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">day</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span>StartDate<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token string">&quot;day&quot;</span><span class="token punctuation">,</span>
  ce<span class="token punctuation">.</span>VerbatimDate <span class="token keyword">as</span> verbatimEventDate<span class="token punctuation">,</span>
  ce<span class="token punctuation">.</span>Remarks <span class="token keyword">as</span> habitat<span class="token punctuation">,</span>
  
  <span class="token comment">-- Location</span>
  l<span class="token punctuation">.</span>GUID <span class="token keyword">as</span> locationID<span class="token punctuation">,</span>
  hg<span class="token punctuation">.</span>higherGeography<span class="token punctuation">,</span>
  ld<span class="token punctuation">.</span>WaterBody <span class="token keyword">as</span> waterBody<span class="token punctuation">,</span>
  ld<span class="token punctuation">.</span>IslandGroup <span class="token keyword">as</span> islandGroup<span class="token punctuation">,</span>
  ld<span class="token punctuation">.</span>Island <span class="token keyword">as</span> island<span class="token punctuation">,</span>
  hg<span class="token punctuation">.</span>continent<span class="token punctuation">,</span>
  hg<span class="token punctuation">.</span>Country <span class="token keyword">as</span> country<span class="token punctuation">,</span>
  g<span class="token punctuation">.</span>Text1 <span class="token keyword">as</span> countryCode<span class="token punctuation">,</span>
  hg<span class="token punctuation">.</span>State <span class="token keyword">as</span> stateProvince<span class="token punctuation">,</span>
  hg<span class="token punctuation">.</span>County <span class="token keyword">as</span> county<span class="token punctuation">,</span>
  l<span class="token punctuation">.</span>LocalityName <span class="token keyword">as</span> verbatimLocality<span class="token punctuation">,</span>
  l<span class="token punctuation">.</span>LocalityName <span class="token keyword">as</span> locality<span class="token punctuation">,</span>
  <span class="token keyword">CASE</span> 
  <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>VerbatimElevation <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> l<span class="token punctuation">.</span>VerbatimElevation
  <span class="token keyword">ELSE</span>
    <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1
    <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>MaxElevation <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>MinElevation<span class="token punctuation">,</span> l<span class="token punctuation">.</span>Text1<span class="token punctuation">)</span> <span class="token keyword">ELSE</span> CONCAT<span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>MaxElevation<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>Text1<span class="token punctuation">)</span> <span class="token keyword">END</span>
    <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
    <span class="token keyword">END</span>
  <span class="token keyword">END</span> <span class="token keyword">as</span> verbatimElevation<span class="token punctuation">,</span>
  <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MinElevation <span class="token keyword">END</span> <span class="token keyword">as</span> minimumElevationInMeters<span class="token punctuation">,</span>
  <span class="token keyword">CASE</span> 
  <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>MaxElevation <span class="token operator">Is</span> <span class="token boolean">Null</span> <span class="token keyword">THEN</span>
    <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MinElevation <span class="token keyword">END</span>
  <span class="token keyword">ELSE</span> 
    <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MaxElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MaxElevation <span class="token keyword">END</span>
  <span class="token keyword">END</span> <span class="token keyword">as</span> maximumElevationInMeters<span class="token punctuation">,</span>
  <span class="token keyword">CASE</span> 
  <span class="token keyword">WHEN</span> EndDepth <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
    <span class="token keyword">CASE</span> StartDepthUnit
    <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">' ft'</span><span class="token punctuation">)</span>
    <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">' fathoms'</span><span class="token punctuation">)</span>
    <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
    <span class="token keyword">END</span>
  <span class="token keyword">ELSE</span>
    <span class="token keyword">CASE</span> StartDepthUnit
    <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> EndDepth<span class="token punctuation">,</span> <span class="token string">' ft'</span><span class="token punctuation">)</span>
    <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> ENDDepth<span class="token punctuation">,</span> <span class="token string">' fathoms'</span><span class="token punctuation">)</span>
    <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
    <span class="token keyword">END</span>
  <span class="token keyword">END</span> <span class="token keyword">as</span> verbatimDepth<span class="token punctuation">,</span>
  <span class="token keyword">CASE</span> StartDepthUnit <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> StartDepth <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">1.8288</span><span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token keyword">as</span> minimumDepthInMeters<span class="token punctuation">,</span>
  <span class="token keyword">CASE</span> 
  <span class="token keyword">WHEN</span> EndDepth <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
    <span class="token keyword">CASE</span> StartDepthUnit <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> StartDepth <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">1.8288</span><span class="token punctuation">)</span> <span class="token keyword">END</span>
  <span class="token keyword">ELSE</span>
    <span class="token keyword">CASE</span> StartDepthUnit <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> EndDepth <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>EndDepth <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>EndDepth <span class="token operator">*</span> <span class="token number">1.8288</span><span class="token punctuation">)</span> <span class="token keyword">END</span>
  <span class="token keyword">END</span> <span class="token keyword">as</span> maximumDepthInMeters<span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Latitude1 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> l<span class="token punctuation">.</span>Longitude1 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>Lat1Text<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> verbatimLatitude<span class="token punctuation">,</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>Latitude1 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token operator">and</span> l<span class="token punctuation">.</span>Longitude1 <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>Long1Text<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">as</span> verbatimLongitude<span class="token punctuation">,</span>
  gc<span class="token punctuation">.</span>OriginalCoordSystem <span class="token keyword">as</span> verbatimCoordinateSystem<span class="token punctuation">,</span>
  srs_from_datum<span class="token punctuation">(</span>l<span class="token punctuation">.</span>Datum<span class="token punctuation">)</span> <span class="token keyword">as</span> verbatimSRS<span class="token punctuation">,</span>
  l<span class="token punctuation">.</span>Latitude1 <span class="token keyword">as</span> decimalLatitude<span class="token punctuation">,</span>
  l<span class="token punctuation">.</span>Longitude1 <span class="token keyword">as</span> decimalLongitude<span class="token punctuation">,</span>
  srs_from_datum<span class="token punctuation">(</span>l<span class="token punctuation">.</span>Datum<span class="token punctuation">)</span> <span class="token keyword">as</span> geodeticDatum<span class="token punctuation">,</span>
  <span class="token keyword">coalesce</span><span class="token punctuation">(</span><span class="token function">ROUND</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>GeoRefAccuracy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>MaxUncertaintyEst<span class="token punctuation">)</span><span class="token punctuation">,</span> coordinate_uncertainty_in_meters<span class="token punctuation">(</span>l<span class="token punctuation">.</span>OriginalElevationUnit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> coordinateUncertaintyInMeters<span class="token punctuation">,</span>
  gc<span class="token punctuation">.</span>NamedPlaceExtent <span class="token keyword">as</span> coordinatePrecision<span class="token punctuation">,</span>
  concat_ws<span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">,</span> gca<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> gca<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span> <span class="token keyword">as</span> georeferencedBy<span class="token punctuation">,</span>
  gc<span class="token punctuation">.</span>GeoRefDetDate <span class="token keyword">as</span> georeferencedDate<span class="token punctuation">,</span>
  l<span class="token punctuation">.</span>LatLongMethod <span class="token keyword">as</span> georeferenceProtocol<span class="token punctuation">,</span>
  gc<span class="token punctuation">.</span>Text1 <span class="token keyword">as</span> georeferenceSources<span class="token punctuation">,</span>
  <span class="token keyword">replace</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>GeoRefVerificationStatus<span class="token punctuation">,</span> <span class="token string">'Corrected'</span><span class="token punctuation">,</span> <span class="token string">'Verified'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> georeferenceVerificationStatus<span class="token punctuation">,</span>
  gc<span class="token punctuation">.</span>GeoRefRemarks <span class="token keyword">as</span> georeferenceRemarks<span class="token punctuation">,</span>
  
  <span class="token comment">-- Identification</span>
  d<span class="token punctuation">.</span>GUID <span class="token keyword">as</span> identificationID<span class="token punctuation">,</span>
  concat_ws<span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">,</span> da<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> da<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span> <span class="token keyword">as</span> identifiedBy<span class="token punctuation">,</span>
  identified_by_id<span class="token punctuation">(</span>d<span class="token punctuation">.</span>DeterminationID<span class="token punctuation">)</span> <span class="token keyword">as</span> identifiedByID<span class="token punctuation">,</span>
  dateWithPrecision<span class="token punctuation">(</span>d<span class="token punctuation">.</span>DeterminedDate<span class="token punctuation">,</span> d<span class="token punctuation">.</span>DeterminedDatePrecision<span class="token punctuation">)</span> <span class="token keyword">as</span> dateIdentified<span class="token punctuation">,</span>
  d<span class="token punctuation">.</span>Remarks <span class="token keyword">as</span> identificationRemarks<span class="token punctuation">,</span>
  dwc_identification_qualifier<span class="token punctuation">(</span>d<span class="token punctuation">.</span>Qualifier<span class="token punctuation">,</span> d<span class="token punctuation">.</span>VarQualifier<span class="token punctuation">,</span> t<span class="token punctuation">.</span>TaxonID<span class="token punctuation">)</span> <span class="token keyword">as</span> identificationQualifier<span class="token punctuation">,</span>
  dwc_type_status<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span> <span class="token keyword">as</span> typeStatus<span class="token punctuation">,</span>
    
  <span class="token comment">-- Taxon</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName <span class="token operator">LIKE</span> <span class="token string">'% [%'</span> <span class="token punctuation">,</span> substring<span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LOCATE<span class="token punctuation">(</span><span class="token string">' ['</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span> <span class="token keyword">as</span> scientificName<span class="token punctuation">,</span>
  t<span class="token punctuation">.</span>Author <span class="token keyword">as</span> scientificNameAuthorship<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>higherTaxonomy <span class="token keyword">as</span> higherClassification<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>kingdom<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>phylum<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span><span class="token punctuation">`</span>class<span class="token punctuation">`</span><span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">order</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>family<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>genus<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>specificEpithet<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>infraspecificEpithet<span class="token punctuation">,</span>
  hc<span class="token punctuation">.</span>taxonRank<span class="token punctuation">,</span>
  t<span class="token punctuation">.</span>Remarks <span class="token keyword">as</span> taxonRemarks<span class="token punctuation">,</span>
  <span class="token string">'ICN'</span> <span class="token keyword">as</span> nomenclaturalCode<span class="token punctuation">,</span>
  t<span class="token punctuation">.</span>EsaStatus <span class="token keyword">as</span> nomenclaturalStatus

<span class="token keyword">from</span> collectionobject co
<span class="token keyword">join</span> collectingevent ce <span class="token keyword">on</span> co<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>ce<span class="token punctuation">.</span>CollectingEventID
<span class="token keyword">left</span> <span class="token keyword">join</span> collectingtrip ctr <span class="token keyword">ON</span> ce<span class="token punctuation">.</span>CollectingTripID<span class="token operator">=</span>ctr<span class="token punctuation">.</span>CollectingTripID
<span class="token keyword">join</span> locality l <span class="token keyword">on</span> ce<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>l<span class="token punctuation">.</span>LocalityID
<span class="token keyword">left</span> <span class="token keyword">join</span> geography g <span class="token keyword">on</span> l<span class="token punctuation">.</span>GeographyID<span class="token operator">=</span>g<span class="token punctuation">.</span>GeographyID
<span class="token keyword">left</span> <span class="token keyword">join</span> aux_highergeography_test hg <span class="token keyword">on</span> g<span class="token punctuation">.</span>GeographyID<span class="token operator">=</span>hg<span class="token punctuation">.</span>GeographyID
<span class="token keyword">left</span> <span class="token keyword">join</span> localitydetail ld <span class="token keyword">on</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>ld<span class="token punctuation">.</span>LocalityID
<span class="token keyword">left</span> <span class="token keyword">join</span> geocoorddetail gc <span class="token keyword">on</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>gc<span class="token punctuation">.</span>LocalityID
<span class="token keyword">left</span> <span class="token keyword">join</span> agent gca <span class="token keyword">on</span> gc<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>gca<span class="token punctuation">.</span>AgentID
<span class="token keyword">left</span> <span class="token keyword">join</span> determination d <span class="token keyword">on</span> co<span class="token punctuation">.</span>CollectionObjectID<span class="token operator">=</span>d<span class="token punctuation">.</span>CollectionObjectID <span class="token operator">and</span> d<span class="token punctuation">.</span>IsCurrent<span class="token operator">=</span><span class="token boolean">true</span>
<span class="token keyword">left</span> <span class="token keyword">join</span> agent da <span class="token keyword">on</span> d<span class="token punctuation">.</span>DeterminerID<span class="token operator">=</span>da<span class="token punctuation">.</span>AgentID
<span class="token keyword">left</span> <span class="token keyword">join</span> taxon t <span class="token keyword">on</span> d<span class="token punctuation">.</span>TaxonID<span class="token operator">=</span>t<span class="token punctuation">.</span>TaxonID
<span class="token keyword">left</span> <span class="token keyword">join</span> aux_highertaxonomy_test hc <span class="token keyword">on</span> t<span class="token punctuation">.</span>TaxonID<span class="token operator">=</span>hc<span class="token punctuation">.</span>TaxonID
<span class="token keyword">where</span> co<span class="token punctuation">.</span>CollectionID<span class="token operator">=</span><span class="token number">4</span>
</code></pre></div><p>This query uses all the functions described in
<a href="../specify-dwc-mapping">Specify to Darwin Core mapping</a>, but there is no need
anymore to store the returned values in the database. The only extra thing that
is needed are tables to cache the higher classification and higher geography,
which I had already in place for use with the BioCASe provider. Without those
tables the query would run very slow indeed and most likely time out.</p> <p>As it is now, the IPT takes just over 20 minutes to publish our entire data set
of almost a million records. The Darwin Core Archive creation
tool in Specify 7 is almost twice as quick, but we cannot use the archives that
are produced with Specify 7, as our data is stored in a different way than we
want to export/publish it in and we also have extensions with external data (for
images for example).</p> <h2 id="extra-functions"><a href="#extra-functions" aria-hidden="true" class="header-anchor">#</a> Extra functions</h2> <p>These extra functions were written to do what is done by formatters and
aggregators in Specify.</p> <h3 id="collectorstring"><a href="#collectorstring" aria-hidden="true" class="header-anchor">#</a> collectorstring()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- collector_string</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>collectorstring<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>collectorstring<span class="token punctuation">`</span><span class="token punctuation">(</span>p_collectingeventid <span class="token keyword">int</span><span class="token punctuation">,</span> p_separator <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> p_primary <span class="token keyword">bit</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
    <span class="token keyword">READS</span> <span class="token keyword">SQL</span> <span class="token keyword">DATA</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">DECLARE</span> out_collector_string <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">IF</span> p_primary<span class="token operator">=</span><span class="token boolean">true</span> <span class="token keyword">THEN</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span>GROUP_CONCAT<span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token operator">!</span>isnull<span class="token punctuation">(</span>a<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span><span class="token punctuation">,</span> CONCAT<span class="token punctuation">(</span>a<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>OrderNumber SEPARATOR <span class="token string">'placeholder-sep'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'placeholder-sep'</span><span class="token punctuation">,</span> p_separator<span class="token punctuation">)</span>
    <span class="token keyword">INTO</span> out_collector_string
    <span class="token keyword">FROM</span> collector c
    <span class="token keyword">JOIN</span> agent a <span class="token keyword">ON</span> c<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>a<span class="token punctuation">.</span>AgentID
    <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>p_collectingeventid <span class="token operator">AND</span> c<span class="token punctuation">.</span>IsPrimary<span class="token operator">=</span>p_primary
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>CollectingEventID<span class="token punctuation">;</span>
  <span class="token keyword">ELSE</span>
    <span class="token keyword">SELECT</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span>GROUP_CONCAT<span class="token punctuation">(</span><span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token operator">!</span>isnull<span class="token punctuation">(</span>a<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span><span class="token punctuation">,</span> CONCAT<span class="token punctuation">(</span>a<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>LastName<span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>OrderNumber SEPARATOR <span class="token string">'placeholder-sep'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'placeholder-sep'</span><span class="token punctuation">,</span> p_separator<span class="token punctuation">)</span>
    <span class="token keyword">INTO</span> out_collector_string
    <span class="token keyword">FROM</span> collector c
    <span class="token keyword">JOIN</span> agent a <span class="token keyword">ON</span> c<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>a<span class="token punctuation">.</span>AgentID
    <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>p_collectingeventid
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>CollectingEventID<span class="token punctuation">;</span>
  <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

  <span class="token keyword">RETURN</span> out_collector_string<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="recorded-by-id"><a href="#recorded-by-id" aria-hidden="true" class="header-anchor">#</a> recorded_by_id()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- recorded_by_id</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>recorded_by_id<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>recorded_by_id<span class="token punctuation">`</span><span class="token punctuation">(</span>in_collecting_event_id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_recorded_by_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> GROUP_CONCAT<span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span>av1<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> av2<span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>OrderNumber SEPARATOR <span class="token string">' | '</span><span class="token punctuation">)</span>
    <span class="token keyword">INTO</span> out_recorded_by_id
    <span class="token keyword">FROM</span> collector c
    <span class="token keyword">JOIN</span> agent a <span class="token keyword">ON</span> c<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>a<span class="token punctuation">.</span>agentID
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> agentvariant av1 <span class="token keyword">ON</span> a<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>av1<span class="token punctuation">.</span>AgentID <span class="token operator">AND</span> av1<span class="token punctuation">.</span>VarType<span class="token operator">=</span><span class="token number">11</span>
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> agentvariant av2 <span class="token keyword">ON</span> a<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>av2<span class="token punctuation">.</span>AgentID <span class="token operator">AND</span> av2<span class="token punctuation">.</span>VarType<span class="token operator">=</span><span class="token number">9</span>
    <span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>in_collecting_event_id <span class="token operator">AND</span> <span class="token punctuation">(</span>av1<span class="token punctuation">.</span>AgentVariantID <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> av2<span class="token punctuation">.</span>AgentVariantID <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> c<span class="token punctuation">.</span>CollectingEventID<span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_recorded_by_id<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="preparations"><a href="#preparations" aria-hidden="true" class="header-anchor">#</a> preparations()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- preparations</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>preparations<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>preparations<span class="token punctuation">`</span><span class="token punctuation">(</span>in_collection_object_id <span class="token keyword">INTEGER</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_preparations <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">SELECT</span> GROUP_CONCAT<span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> pt<span class="token punctuation">.</span>Name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> pt<span class="token punctuation">.</span>PrepTypeID SEPARATOR <span class="token string">' | '</span><span class="token punctuation">)</span>
    <span class="token keyword">INTO</span> out_preparations
	<span class="token keyword">FROM</span> preparation p
	<span class="token keyword">JOIN</span> preptype pt <span class="token keyword">ON</span> p<span class="token punctuation">.</span>PrepTypeID<span class="token operator">=</span>pt<span class="token punctuation">.</span>PrepTypeID
	<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>CollectionObjectID<span class="token operator">=</span>in_collection_object_id <span class="token operator">AND</span> pt<span class="token punctuation">.</span>PrepTypeID <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span>
	<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> p<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_preparations<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="associated-sequences"><a href="#associated-sequences" aria-hidden="true" class="header-anchor">#</a> associated_sequences()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- associated_sequences</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>associated_sequences<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>associated_sequences<span class="token punctuation">`</span><span class="token punctuation">(</span>in_collection_object_id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_associated_sequences <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> group_concat<span class="token punctuation">(</span>concat<span class="token punctuation">(</span><span class="token string">'https://www.ncbi.nlm.nih.gov/nuccore/'</span><span class="token punctuation">,</span> GenBankAccessionNumber<span class="token punctuation">)</span> SEPARATOR <span class="token string">' | '</span><span class="token punctuation">)</span>
    <span class="token keyword">INTO</span> out_associated_sequences
    <span class="token keyword">FROM</span> dnasequence
    <span class="token keyword">WHERE</span> CollectionObjectID<span class="token operator">=</span>in_collection_object_id
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> CollectionObjectID<span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_associated_sequences<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="previous-identifications"><a href="#previous-identifications" aria-hidden="true" class="header-anchor">#</a> previous_identifications()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- previous_identifications</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>previous_identifications<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>previous_identifications<span class="token punctuation">`</span><span class="token punctuation">(</span>in_collection_object_id <span class="token keyword">INTEGER</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">text</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_previous_identifications <span class="token keyword">TEXT</span><span class="token punctuation">;</span>
	<span class="token keyword">select</span> 
	  group_concat<span class="token punctuation">(</span>identification_string<span class="token punctuation">(</span>concat_ws<span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">,</span> concat_ws<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName <span class="token operator">LIKE</span> <span class="token string">'% [%'</span> <span class="token punctuation">,</span> substring<span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LOCATE<span class="token punctuation">(</span><span class="token string">' ['</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>author<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>EsaStatus<span class="token punctuation">)</span><span class="token punctuation">,</span> 
		concat_ws<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>LastName<span class="token punctuation">,</span> a<span class="token punctuation">.</span>FirstName<span class="token punctuation">)</span><span class="token punctuation">,</span> dateWithPrecision<span class="token punctuation">(</span>d<span class="token punctuation">.</span>DeterminedDate<span class="token punctuation">,</span> d<span class="token punctuation">.</span>DeterminedDatePrecision<span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>Remarks<span class="token punctuation">)</span> SEPARATOR <span class="token string">' | '</span><span class="token punctuation">)</span> <span class="token keyword">as</span> previousIdentifications
	<span class="token keyword">into</span> out_previous_identifications
	<span class="token keyword">from</span> determination d
	<span class="token keyword">join</span> taxon t <span class="token keyword">on</span> d<span class="token punctuation">.</span>TaxonID<span class="token operator">=</span>t<span class="token punctuation">.</span>TaxonID
	<span class="token keyword">left</span> <span class="token keyword">join</span> agent a <span class="token keyword">on</span> d<span class="token punctuation">.</span>DeterminerID<span class="token operator">=</span>a<span class="token punctuation">.</span>AgentID
	<span class="token keyword">where</span> d<span class="token punctuation">.</span>CollectionObjectID<span class="token operator">=</span>in_collection_object_id <span class="token operator">and</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>IsCurrent<span class="token operator">=</span><span class="token boolean">false</span> <span class="token operator">or</span> d<span class="token punctuation">.</span>IsCurrent <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span>FeatureOrBasis<span class="token operator">!=</span><span class="token string">'Type status'</span> <span class="token operator">or</span> d<span class="token punctuation">.</span>FeatureOrBasis <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">)</span>
	<span class="token keyword">group</span> <span class="token keyword">by</span> d<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_previous_identifications<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="identification-string"><a href="#identification-string" aria-hidden="true" class="header-anchor">#</a> identification_string()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- identification_string</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>identification_string<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>identification_string<span class="token punctuation">`</span><span class="token punctuation">(</span>in_scientific_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_identified_by <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_date_identified <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_identification_remarks <span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">text</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_identification_string <span class="token keyword">TEXT</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> out_identification_string <span class="token operator">=</span> in_scientific_name<span class="token punctuation">;</span>
    <span class="token keyword">IF</span> in_identified_by <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> in_identified_by<span class="token operator">!=</span><span class="token string">''</span> <span class="token keyword">THEN</span>
		<span class="token keyword">SET</span> out_identification_string <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>out_identification_string<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> in_identified_by<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">IF</span> in_date_identified <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> in_date_identified<span class="token operator">!=</span><span class="token string">''</span> <span class="token keyword">THEN</span>
			<span class="token keyword">SET</span> out_identification_string <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>out_identification_string<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> in_date_identified<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span>
        <span class="token keyword">IF</span> in_date_identified <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> in_date_identified<span class="token operator">!=</span><span class="token string">''</span> <span class="token keyword">THEN</span>
			<span class="token keyword">SET</span> out_identification_string <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>out_identification_string<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> in_date_identified<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> in_identification_remarks <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> in_identification_remarks<span class="token operator">!=</span><span class="token string">''</span> <span class="token keyword">THEN</span>
		<span class="token keyword">SET</span> out_identification_string <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>out_identification_string<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> in_identification_remarks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    
<span class="token keyword">RETURN</span> out_identification_string<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="identified-by-id"><a href="#identified-by-id" aria-hidden="true" class="header-anchor">#</a> identified_by_id()</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">-- identified_by_id</span>
<span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>identified_by_id<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>identified_by_id<span class="token punctuation">`</span><span class="token punctuation">(</span>in_determination_id <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_identified_by_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">SELECT</span> GROUP_CONCAT<span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span>av1<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> av2<span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> gp<span class="token punctuation">.</span>OrderNumber SEPARATOR <span class="token string">' | '</span><span class="token punctuation">)</span>
    <span class="token keyword">INTO</span> out_identified_by_id
	<span class="token keyword">FROM</span> determination d
	<span class="token keyword">JOIN</span> agent a <span class="token keyword">ON</span> d<span class="token punctuation">.</span>DeterminerID<span class="token operator">=</span>a<span class="token punctuation">.</span>AgentID
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> groupperson gp <span class="token keyword">ON</span> a<span class="token punctuation">.</span>AgentID<span class="token operator">=</span>gp<span class="token punctuation">.</span>GroupID
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> agent m <span class="token keyword">ON</span> gp<span class="token punctuation">.</span>MemberID<span class="token operator">=</span>m<span class="token punctuation">.</span>AgentID
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> agentvariant av1 <span class="token keyword">ON</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>AgentID<span class="token punctuation">,</span> a<span class="token punctuation">.</span>AgentID<span class="token punctuation">)</span><span class="token operator">=</span>av1<span class="token punctuation">.</span>AgentID <span class="token operator">AND</span> av1<span class="token punctuation">.</span>VarType<span class="token operator">=</span><span class="token number">11</span>
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> agentvariant av2 <span class="token keyword">ON</span> <span class="token keyword">COALESCE</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>AgentID<span class="token punctuation">,</span> a<span class="token punctuation">.</span>AgentID<span class="token punctuation">)</span><span class="token operator">=</span>av2<span class="token punctuation">.</span>AgentID <span class="token operator">AND</span> av2<span class="token punctuation">.</span>VarType<span class="token operator">=</span><span class="token number">9</span>
	<span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>DeterminationID<span class="token operator">=</span>in_determination_id <span class="token operator">AND</span> <span class="token punctuation">(</span>av1<span class="token punctuation">.</span>AgentVariantID <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> av2<span class="token punctuation">.</span>AgentID <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
	<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> d<span class="token punctuation">.</span>DeterminationID<span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_identified_by_id<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h2 id="denormalise-trees"><a href="#denormalise-trees" aria-hidden="true" class="header-anchor">#</a> Denormalise trees</h2> <h3 id="taxon-tree"><a href="#taxon-tree" aria-hidden="true" class="header-anchor">#</a> Taxon tree</h3> <p>In order for the publication of the Darwin Core Archive to complete in a
reasonable amont of time, we need to cache a denormalised version of the Taxon
tree. This table stores all taxonomic ranks in a single record, so we can just
join it to the Taxon table and do not have to do a lot of recurrent querying.</p> <p>We also add some other classification related terms, <code>taxonRank</code> and
<code>higherTaxonomy</code> (I called it <code>higherTaxonomy</code> because I got my Darwin Core
terms wrong and have not changed it to <code>higherClassification</code> yet, as I am not
sure that I am not using this table for anything else).</p> <p>While you could just update the records that have changed since the last update,
I choose to replace all records every time – even though this takes almost three
hours – as I am not sure every change in the Taxon tree will lead to a change of
the <code>TimestampModified</code> in the Taxon table. It is not terrible if a Darwin Core
Archive is published before the auxilliary higher taxonomy table has been
updated, as the essential information is in the Taxon table and the higher
classification can be picked up in the next publication. We publish every week.</p> <p><strong>Table create statement</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>aux_highertaxonomy_test<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>TaxonID<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>taxonRank<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>kingdom<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>phylum<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>class<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">order</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>family<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>genus<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>specificEpithet<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>infraspecificEpithet<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>higherTaxonomy<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>TaxonID<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p><strong>Procedure to update the higher taxonomy table</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>reindex_higher_taxonymy<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>reindex_higher_taxonymy<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
taxa: <span class="token keyword">BEGIN</span>
    
    <span class="token keyword">DECLARE</span> var_taxon_id <span class="token keyword">INTEGER</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_node_number <span class="token keyword">INT</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_taxon_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> var_finished <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> taxon_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> 
        <span class="token keyword">SELECT</span> t<span class="token punctuation">.</span>TaxonID<span class="token punctuation">,</span> t<span class="token punctuation">.</span>NodeNumber<span class="token punctuation">,</span> td<span class="token punctuation">.</span>Name
        <span class="token keyword">FROM</span> taxon t
        <span class="token keyword">JOIN</span> taxontreedefitem td <span class="token keyword">ON</span> t<span class="token punctuation">.</span>TaxonTreeDefItemID<span class="token operator">=</span>td<span class="token punctuation">.</span>TaxonTreeDefItemID
        <span class="token keyword">JOIN</span> determination d <span class="token keyword">ON</span> t<span class="token punctuation">.</span>TaxonID<span class="token operator">=</span>d<span class="token punctuation">.</span>TaxonID
        <span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>CollectionMemberID<span class="token operator">=</span><span class="token number">4</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> t<span class="token punctuation">.</span>TaxonID<span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> var_finished <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">TRUNCATE</span> aux_highertaxonomy_test<span class="token punctuation">;</span>

    <span class="token keyword">OPEN</span> taxon_cursor<span class="token punctuation">;</span>
    taxon_loop: <span class="token keyword">LOOP</span>
        <span class="token keyword">FETCH</span> taxon_cursor 
        <span class="token keyword">INTO</span> var_taxon_id<span class="token punctuation">,</span> var_node_number<span class="token punctuation">,</span> var_taxon_rank<span class="token punctuation">;</span>

        <span class="token keyword">CALL</span> replace_higher_taxonomy_record<span class="token punctuation">(</span>var_taxon_id<span class="token punctuation">,</span> var_node_number<span class="token punctuation">,</span> var_taxon_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">IF</span> var_finished <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
            <span class="token keyword">LEAVE</span> taxon_loop<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">LOOP</span> taxon_loop<span class="token punctuation">;</span>
    <span class="token keyword">CLOSE</span> taxon_cursor<span class="token punctuation">;</span>
</code></pre></div><p><strong>Procedure to replace a higher taxonomy record</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">procedure</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>replace_higher_taxonomy_record<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>replace_higher_taxonomy_record<span class="token punctuation">`</span><span class="token punctuation">(</span>in_taxon_id <span class="token keyword">INTEGER</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_node_number <span class="token keyword">INT</span><span class="token punctuation">,</span> in_taxon_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> var_kingdom <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_phylum <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_class <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_order <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_family <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_genus <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_specific_epithet <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_infraspecific_epithet <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_higher_taxonomy <span class="token keyword">TEXT</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> var_taxonomy_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_taxonomy_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_taxonomy_full_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> var_finished <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> higher_taxonomy_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span>
        <span class="token keyword">SELECT</span> td<span class="token punctuation">.</span>Name <span class="token keyword">as</span> var_rank<span class="token punctuation">,</span> t<span class="token punctuation">.</span>name <span class="token keyword">as</span> var_name<span class="token punctuation">,</span> <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName <span class="token operator">LIKE</span> <span class="token string">'% [%'</span> <span class="token punctuation">,</span> substring<span class="token punctuation">(</span>t<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LOCATE<span class="token punctuation">(</span><span class="token string">' ['</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">)</span>
        <span class="token keyword">FROM</span> taxon t
        <span class="token keyword">JOIN</span> taxontreedefitem td <span class="token keyword">ON</span> t<span class="token punctuation">.</span>TaxonTreeDefItemID<span class="token operator">=</span>td<span class="token punctuation">.</span>TaxonTreeDefItemID
        <span class="token keyword">WHERE</span> NodeNumber<span class="token operator">&lt;=</span>in_node_number <span class="token operator">AND</span> HighestChildNodeNumber<span class="token operator">&gt;=</span>in_node_number 
            <span class="token operator">AND</span> NodeNumber<span class="token operator">&gt;</span><span class="token number">1</span> <span class="token operator">AND</span> t<span class="token punctuation">.</span>Name <span class="token operator">NOT</span> <span class="token operator">LIKE</span> <span class="token string">'%indet.'</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> td<span class="token punctuation">.</span>RankID<span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> var_finished <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">OPEN</span> higher_taxonomy_cursor<span class="token punctuation">;</span>
    higher_taxonomy_loop: <span class="token keyword">LOOP</span>
        <span class="token keyword">FETCH</span> higher_taxonomy_cursor
        <span class="token keyword">INTO</span> var_taxonomy_rank<span class="token punctuation">,</span> var_taxonomy_name<span class="token punctuation">,</span> var_taxonomy_full_name<span class="token punctuation">;</span>

        <span class="token keyword">IF</span> var_taxonomy_rank <span class="token operator">!=</span> in_taxon_rank <span class="token keyword">THEN</span>
            <span class="token keyword">IF</span> var_higher_taxonomy <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
                <span class="token keyword">SET</span> var_higher_taxonomy <span class="token operator">=</span> var_taxonomy_full_name<span class="token punctuation">;</span>
            <span class="token keyword">ELSE</span>
                <span class="token keyword">SET</span> var_higher_taxonomy <span class="token operator">=</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">,</span> var_higher_taxonomy<span class="token punctuation">,</span> var_taxonomy_full_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

        <span class="token keyword">CASE</span> var_taxonomy_rank
            <span class="token keyword">WHEN</span> <span class="token string">'kingdom'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_kingdom <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'division'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_phylum <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span> 
            <span class="token keyword">WHEN</span> <span class="token string">'class'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_class <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'order'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_order <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'family'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_family <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'genus'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> var_genus <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'species'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_specific_epithet <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'subspecies'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_infraspecific_epithet <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'variety'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_infraspecific_epithet <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'subvariety'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_infraspecific_epithet <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'forma'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_infraspecific_epithet <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'subforma'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_infraspecific_epithet <span class="token operator">=</span> var_taxonomy_name<span class="token punctuation">;</span>
            <span class="token keyword">ELSE</span> 
				<span class="token keyword">BEGIN</span> <span class="token keyword">END</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>

        <span class="token keyword">IF</span> var_finished <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
            <span class="token keyword">LEAVE</span> higher_taxonomy_loop<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">LOOP</span> higher_taxonomy_loop<span class="token punctuation">;</span>
    
    <span class="token keyword">IF</span> in_taxon_rank<span class="token operator">=</span><span class="token string">'division'</span> <span class="token keyword">THEN</span> 
		<span class="token keyword">SET</span> in_taxon_rank<span class="token operator">=</span><span class="token string">'phylum'</span><span class="token punctuation">;</span> 
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

    <span class="token keyword">REPLACE</span> <span class="token keyword">INTO</span> aux_highertaxonomy_test <span class="token punctuation">(</span>TaxonID<span class="token punctuation">,</span> taxonRank<span class="token punctuation">,</span>
        kingdom<span class="token punctuation">,</span> phylum<span class="token punctuation">,</span> <span class="token punctuation">`</span>class<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">order</span><span class="token punctuation">`</span><span class="token punctuation">,</span> family<span class="token punctuation">,</span> genus<span class="token punctuation">,</span> specificEpithet<span class="token punctuation">,</span> infraspecificEpithet<span class="token punctuation">,</span>
        higherTaxonomy<span class="token punctuation">,</span> modified<span class="token punctuation">)</span>
    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>in_taxon_id<span class="token punctuation">,</span> in_taxon_rank<span class="token punctuation">,</span> 
        var_kingdom<span class="token punctuation">,</span> var_phylum<span class="token punctuation">,</span> var_class<span class="token punctuation">,</span> var_order<span class="token punctuation">,</span> var_family<span class="token punctuation">,</span> var_genus<span class="token punctuation">,</span>
        var_specific_epithet<span class="token punctuation">,</span> var_infraspecific_epithet<span class="token punctuation">,</span> var_higher_taxonomy<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">CLOSE</span> higher_taxonomy_cursor<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="geography-tree"><a href="#geography-tree" aria-hidden="true" class="header-anchor">#</a> Geography tree</h3> <p>The Geography tree also needs to be flattened. I have added <code>countryCode</code> to
this table as well, so it does not need to be stored in a custom field in the
Geography table.</p> <p>We use the <a href="https://www.tdwg.org/standards/wgsrpd/" target="_blank" rel="noopener noreferrer">TDWG World Geographical Scheme for Recording Plant Distributions (WGSRPD)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
in our Geography tree and, while we are moving away from that, the WGSRPD Level
1 regions play an important role in how we store specimens and are printed on
our labels, so we cannot change them in our Geography tree. Therefore, I have
created a function that maps the WGSRPD Level 1 regions (which we just call
'Continents' in our database) to continents and store the latter in the
auxilliary table.</p> <p>A full re-index of this table takes well under a minute.</p> <p><strong>Table create statement</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>aux_highergeography_test<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>GeographyID<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>GeographyRank<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>Continent<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>Country<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>State<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>County<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>higherGeography<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>countryCode<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>GeographyIDUNIQ<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>GeographyID<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p><strong>Procedure to update higher geography table</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>reindex_higher_geography<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>reindex_higher_geography<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    
    <span class="token keyword">DECLARE</span> var_geography_id <span class="token keyword">INTEGER</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_node_number <span class="token keyword">INT</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_geography_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> var_finished <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> geography_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> 
        <span class="token keyword">SELECT</span> g<span class="token punctuation">.</span>GeographyID<span class="token punctuation">,</span> g<span class="token punctuation">.</span>NodeNumber<span class="token punctuation">,</span> gd<span class="token punctuation">.</span>Name
        <span class="token keyword">FROM</span> geography g
        <span class="token keyword">JOIN</span> geographytreedefitem gd <span class="token keyword">ON</span> g<span class="token punctuation">.</span>GeographyTreeDefItemID<span class="token operator">=</span>gd<span class="token punctuation">.</span>GeographyTreeDefItemID
        <span class="token keyword">JOIN</span> locality l <span class="token keyword">ON</span> g<span class="token punctuation">.</span>GeographyID<span class="token operator">=</span>l<span class="token punctuation">.</span>GeographyID
        <span class="token keyword">JOIN</span> collectingevent ce <span class="token keyword">ON</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>ce<span class="token punctuation">.</span>CollectingEventID
        <span class="token keyword">JOIN</span> collectionobject co <span class="token keyword">ON</span> ce<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>co<span class="token punctuation">.</span>CollectingEventID
        <span class="token keyword">WHERE</span> co<span class="token punctuation">.</span>CollectionID<span class="token operator">=</span><span class="token number">4</span>
        <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> g<span class="token punctuation">.</span>GeographyID<span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> var_finished <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">TRUNCATE</span> aux_highergeography_test<span class="token punctuation">;</span>

    <span class="token keyword">OPEN</span> geography_cursor<span class="token punctuation">;</span>
    geography_loop: <span class="token keyword">LOOP</span>
        <span class="token keyword">FETCH</span> geography_cursor 
        <span class="token keyword">INTO</span> var_geography_id<span class="token punctuation">,</span> var_node_number<span class="token punctuation">,</span> var_geography_rank<span class="token punctuation">;</span>

        <span class="token keyword">CALL</span> replace_higher_geography_record<span class="token punctuation">(</span>var_geography_id<span class="token punctuation">,</span> var_node_number<span class="token punctuation">,</span> var_geography_rank<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">IF</span> var_finished <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
            <span class="token keyword">LEAVE</span> geography_loop<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">LOOP</span> geography_loop<span class="token punctuation">;</span>
    <span class="token keyword">CLOSE</span> geography_cursor<span class="token punctuation">;</span>
<span class="token keyword">END</span> $$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p><strong>Procedure to replace a higher geography record</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">procedure</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>replace_higher_geography_record<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>replace_higher_geography_record<span class="token punctuation">`</span><span class="token punctuation">(</span>in_geography_id <span class="token keyword">INTEGER</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_node_number <span class="token keyword">INT</span><span class="token punctuation">,</span> in_geography_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> var_continent <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_country <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_state <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_county <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_higher_geography <span class="token keyword">TEXT</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> var_geography_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_geography_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_geography_full_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_geography_code <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_country_code <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> var_finished <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> higher_geography_cursor <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span>
        <span class="token keyword">SELECT</span> gd<span class="token punctuation">.</span>Name <span class="token keyword">as</span> var_rank<span class="token punctuation">,</span> g<span class="token punctuation">.</span>name <span class="token keyword">as</span> var_name<span class="token punctuation">,</span> g<span class="token punctuation">.</span>GeographyCode <span class="token keyword">AS</span> var_code
        <span class="token keyword">FROM</span> geography g
        <span class="token keyword">JOIN</span> geographytreedefitem gd <span class="token keyword">ON</span> g<span class="token punctuation">.</span>GeographyTreeDefItemID<span class="token operator">=</span>gd<span class="token punctuation">.</span>GeographyTreeDefItemID
        <span class="token keyword">WHERE</span> g<span class="token punctuation">.</span>NodeNumber<span class="token operator">&lt;=</span>in_node_number <span class="token operator">AND</span> g<span class="token punctuation">.</span>HighestChildNodeNumber<span class="token operator">&gt;=</span>in_node_number 
            <span class="token operator">AND</span> g<span class="token punctuation">.</span>NodeNumber<span class="token operator">&gt;</span><span class="token number">1</span> <span class="token operator">AND</span> g<span class="token punctuation">.</span>GeographyTreeDefID<span class="token operator">=</span><span class="token number">1</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> gd<span class="token punctuation">.</span>RankID<span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">SET</span> var_finished <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">OPEN</span> higher_geography_cursor<span class="token punctuation">;</span>
    higher_geography_loop: <span class="token keyword">LOOP</span>
        <span class="token keyword">FETCH</span> higher_geography_cursor
        <span class="token keyword">INTO</span> var_geography_rank<span class="token punctuation">,</span> var_geography_name<span class="token punctuation">,</span> var_geography_code<span class="token punctuation">;</span>
        
        <span class="token keyword">IF</span> var_geography_rank <span class="token operator">=</span> <span class="token string">'Continent'</span> <span class="token keyword">THEN</span>
			<span class="token keyword">SET</span> var_geography_name <span class="token operator">=</span> map_continent<span class="token punctuation">(</span>var_geography_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

        <span class="token keyword">IF</span> var_geography_rank <span class="token operator">!=</span> in_geography_rank <span class="token keyword">THEN</span>
            <span class="token keyword">IF</span> var_higher_geography <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
                <span class="token keyword">SET</span> var_higher_geography <span class="token operator">=</span> var_geography_name<span class="token punctuation">;</span>
            <span class="token keyword">ELSE</span>
                <span class="token keyword">SET</span> var_higher_geography <span class="token operator">=</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">,</span> var_higher_geography<span class="token punctuation">,</span> var_geography_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

        <span class="token keyword">CASE</span> var_geography_rank
            <span class="token keyword">WHEN</span> <span class="token string">'continent'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_continent <span class="token operator">=</span> var_geography_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'country'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_country <span class="token operator">=</span> var_geography_name<span class="token punctuation">;</span> 
                <span class="token keyword">SET</span> var_country_code<span class="token operator">=</span>var_geography_code<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'state'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_state <span class="token operator">=</span> var_geography_name<span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token string">'county'</span> <span class="token keyword">THEN</span> 
				<span class="token keyword">SET</span> var_county <span class="token operator">=</span> var_geography_name<span class="token punctuation">;</span>
            <span class="token keyword">ELSE</span> <span class="token keyword">BEGIN</span> <span class="token keyword">END</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>

        <span class="token keyword">IF</span> var_finished <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
            <span class="token keyword">LEAVE</span> higher_geography_loop<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">LOOP</span> higher_geography_loop<span class="token punctuation">;</span>

    <span class="token keyword">REPLACE</span> <span class="token keyword">INTO</span> aux_highergeography_test <span class="token punctuation">(</span>GeographyID<span class="token punctuation">,</span> geographyRank<span class="token punctuation">,</span>
        continent<span class="token punctuation">,</span> country<span class="token punctuation">,</span> <span class="token punctuation">`</span>state<span class="token punctuation">`</span><span class="token punctuation">,</span> county<span class="token punctuation">,</span> higherGeography<span class="token punctuation">,</span> countryCode<span class="token punctuation">,</span> modified<span class="token punctuation">)</span>
    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>in_geography_id<span class="token punctuation">,</span> in_geography_rank<span class="token punctuation">,</span> 
        var_continent<span class="token punctuation">,</span> var_country<span class="token punctuation">,</span> var_state<span class="token punctuation">,</span> var_county<span class="token punctuation">,</span> var_higher_geography<span class="token punctuation">,</span> var_country_code<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">CLOSE</span> higher_geography_cursor<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p><strong>map_continent() function</strong></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>map_continent<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>map_continent<span class="token punctuation">`</span><span class="token punctuation">(</span>in_continent <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_continent <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> out_continent <span class="token operator">=</span> <span class="token keyword">CASE</span> in_continent
      <span class="token keyword">WHEN</span> <span class="token string">'1. Europe'</span> <span class="token keyword">THEN</span> <span class="token string">'Europe'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'2. Africa'</span> <span class="token keyword">THEN</span> <span class="token string">'Africa'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'3. Asia-Temperate'</span> <span class="token keyword">THEN</span> <span class="token string">'Asia'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'4. Asia-Tropical'</span> <span class="token keyword">THEN</span> <span class="token string">'Asia'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'5. Australasia'</span> <span class="token keyword">THEN</span> <span class="token string">'Oceania'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'6. Pacific'</span> <span class="token keyword">THEN</span> <span class="token string">'Oceania'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'7. Northern America'</span> <span class="token keyword">THEN</span> <span class="token string">'North America'</span>
	  <span class="token keyword">WHEN</span> <span class="token string">'8. Southern America'</span> <span class="token keyword">THEN</span> <span class="token string">'South America'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'9. Antarctica'</span> <span class="token keyword">THEN</span> <span class="token string">'Antarctica'</span> 
      <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
	<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_continent<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/23/2020, 4:31:26 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/" class="prev">
          Specify to Darwin Core mapping
        </a></span> <span class="next"><a href="/melisr-docs-vuepress/additional-documents/people-in-specify/">
          People and people identifiers in Specify
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/melisr-docs-vuepress/assets/js/app.ed396d9f.js" defer></script><script src="/melisr-docs-vuepress/assets/js/3.08a0837d.js" defer></script><script src="/melisr-docs-vuepress/assets/js/32.aef22f61.js" defer></script>
  </body>
</html>
