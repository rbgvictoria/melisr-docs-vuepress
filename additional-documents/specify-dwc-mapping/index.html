<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Specify to Darwin Core mapping | MELISR documentation</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/melisr-docs-vuepress/assets/css/0.styles.4e056352.css" as="style"><link rel="preload" href="/melisr-docs-vuepress/assets/js/app.ed396d9f.js" as="script"><link rel="preload" href="/melisr-docs-vuepress/assets/js/3.08a0837d.js" as="script"><link rel="preload" href="/melisr-docs-vuepress/assets/js/16.07b41535.js" as="script"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/10.5ae15643.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/11.1adacd3d.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/12.587868a1.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/13.ac7bcf09.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/14.02675d19.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/15.40e7bd7e.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/17.23e92267.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/18.42e0d9d6.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/19.5dd49a63.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/2.c6acca67.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/20.22f6b089.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/21.9881b452.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/22.503b342f.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/23.fae0bb15.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/24.3b18ed35.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/25.1dd8e852.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/26.e6e89cf6.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/27.12b6fdb0.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/28.8788af6a.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/29.8c4a54b9.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/30.8e54ddc7.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/31.d48320b5.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/32.aef22f61.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/33.43d76f8d.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/34.c625cab3.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/35.8632b307.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/36.1d0b34c3.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/37.6faa5075.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/38.7311e6ab.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/4.b5565ff5.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/5.3e537086.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/6.211bd2e1.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/7.56738cb3.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/8.a906b5fb.js"><link rel="prefetch" href="/melisr-docs-vuepress/assets/js/9.f1f1474a.js">
    <link rel="stylesheet" href="/melisr-docs-vuepress/assets/css/0.styles.4e056352.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/melisr-docs-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">MELISR documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/melisr-docs-vuepress/data-entry-manual/" class="nav-link">Data entry manual</a></div><div class="nav-item"><a href="/melisr-docs-vuepress/additional-documents/" class="nav-link router-link-active">Additional documents</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/melisr-docs-vuepress/data-entry-manual/" class="nav-link">Data entry manual</a></div><div class="nav-item"><a href="/melisr-docs-vuepress/additional-documents/" class="nav-link router-link-active">Additional documents</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/melisr-docs-vuepress/additional-documents/melisr-fields-in-avh/" class="sidebar-link">MELISR fields in AVH</a></li><li><a href="/melisr-docs-vuepress/additional-documents/herbarium-interactions/" class="sidebar-link">Herbarium interactions</a></li><li><a href="/melisr-docs-vuepress/additional-documents/business-case/" class="sidebar-link">Business case (2009)</a></li><li><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/" class="active sidebar-link">Specify to Darwin Core mapping</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#preparing-the-schema" class="sidebar-link">Preparing the schema</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#pre-processing" class="sidebar-link">Pre-processing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#record-level-terms" class="sidebar-link">Record Level Terms</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#occurrence" class="sidebar-link">Occurrence</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#event" class="sidebar-link">Event</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#location" class="sidebar-link">Location</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#geo-reference" class="sidebar-link">Geo-reference</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#identification" class="sidebar-link">Identification</a></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#taxon" class="sidebar-link">Taxon</a></li></ul></li><li class="sidebar-sub-header"><a href="/melisr-docs-vuepress/additional-documents/specify-dwc-mapping/#post-processing" class="sidebar-link">Post-processing</a></li></ul></li><li><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/" class="sidebar-link">Specify IPT integration</a></li><li><a href="/melisr-docs-vuepress/additional-documents/people-in-specify/" class="sidebar-link">People and people identifiers in Specify</a></li><li><a href="/melisr-docs-vuepress/additional-documents/qa-tests/" class="sidebar-link">Quality assurance tests</a></li><li><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration-pt2/" class="sidebar-link">Specify IPT integration – Part 2</a></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="specify-to-darwin-core-mapping"><a href="#specify-to-darwin-core-mapping" aria-hidden="true" class="header-anchor">#</a> Specify to Darwin Core mapping</h1> <p>The National Herbarium of Victoria (MEL), like other Australian herbaria, used
to deliver data to the Australasian Virtual Herbarium (AVH) as ABCD 2.06 through
a BioCASe provider. The table structure that fed the BioCASe provider was
created using a PHP application that has become very hard to maintain.</p> <p>The Atlas of Living Australia (ALA), which has been hosting the AVH since 2012,
has never accepted ABCD, so for the last eight years MEL has been harvesting the
BioCASe providers of other Australian herbaria as well and has been transforming
ABCD to Darwin Core, which was then delivered as deltas in Darwin Core Archives
to ALA.</p> <p>When the deltas became a problem for ALA – or we finally realised they were a
problem – MEL has started weekly delivery of the full AVH data set of 5M records
to ALA through the GBIF Integrated Publishing Toolkit (IPT). At that time, early
2019, it was decided that we would phase out the BioCASe providers and that all
Australian herbaria should prepare to deliver their own data as Darwin Core
Archives directly to ALA.</p> <p>The biggest barrier for MEL to export data from our collections database
directly as Darwin Core was that the MEL AVH data set in ALA also contained the
data that was harvested from other Australian herbaria's BioCASe providers and
that some herbaria will keep depending on MEL harvesting their BioCASe providers
longer than others. So we have had a Darwin Core mapping for over a year without
being able to use it.</p> <p>Over the first half of 2020 the MEL AVH data resource in ALA was split into
individual data resources for each herbarium (which was not nearly as easy as it
sounds). This opened the way for MEL to start exporting data from its Specify
database directly as Darwin Core into an IPT using the Schema Mapper and Data
Exporter tool that are available in Specify.</p> <h2 id="preparing-the-schema"><a href="#preparing-the-schema" aria-hidden="true" class="header-anchor">#</a> Preparing the schema</h2> <p>Because Darwin Core has been updated since we first set up our database about
ten years ago, I had to import the latest Darwin Core Schema. The Darwin Core
schema is missing the record level terms that are borrowed from Dublin Core. We
only need <code>modified</code>, as the other Dublin Core terms that we use have standard
values for the entire data set.</p> <p>I added <code>modified</code> to the schema like so:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> spexportschemaitem <span class="token punctuation">(</span>TimestampCreated<span class="token punctuation">,</span> TimestampModified<span class="token punctuation">,</span> Version<span class="token punctuation">,</span> 
    CreatedByAgentID<span class="token punctuation">,</span> DataType<span class="token punctuation">,</span> FieldName<span class="token punctuation">,</span> SpExportSchemaID<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'xs:dateTimeIso'</span><span class="token punctuation">,</span> <span class="token string">'modified'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Also, the collecting date is stored in Specify as <code>StartDate</code> and <code>EndDate</code>,
the Darwin Core <code>eventDate</code> is an ISO 8601 date string with the start and end
date separated by a slash ('/'). Therefore, if there is an end date (I
discovered that almost 4,000 of our records have one), it can not be mapped
correctly to <code>eventDate</code>. I have &quot;resolved&quot; this by adding <code>eventDateStart</code>
and <code>eventDateEnd</code> to the schema.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> spexportschemaitem <span class="token punctuation">(</span>TimestampCreated<span class="token punctuation">,</span> TimestampModified<span class="token punctuation">,</span> Version<span class="token punctuation">,</span> 
    CreatedByAgentID<span class="token punctuation">,</span> DataType<span class="token punctuation">,</span> FieldName<span class="token punctuation">,</span> SpExportSchemaID<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'xs:dateTimeIso'</span><span class="token punctuation">,</span> <span class="token string">'eventDateStart'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'xs:dateTimeIso'</span><span class="token punctuation">,</span> <span class="token string">'eventDateEnd'</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>eventDateStart</code> and <code>eventDateEnd</code> will be concatenated into <code>eventDate</code> in the
query that feeds the IPT.</p> <h2 id="pre-processing"><a href="#pre-processing" aria-hidden="true" class="header-anchor">#</a> Pre-processing</h2> <p>For many terms there is no straight mapping from the Specify data model – or
at least the implementation at the National Herbarium of Victoria – to Darwin
Core terms, so some pre-processing of data is necessary.</p> <p>I have tried to do this as much as possible in SQL, which can be stored in the
database as functions and stored procedures, but for some of the <strong>Location</strong>
terms the processing needed went beyond what I can do in MySQL, so I have
used a bit of Python as well.</p> <h3 id="record-level-terms"><a href="#record-level-terms" aria-hidden="true" class="header-anchor">#</a> Record Level Terms</h3> <p><img src="/melisr-docs-vuepress/assets/img/record-level-terms-2020-10-14-132111.038ff996.jpg" alt="DwC mapping Record Level Terms"></p> <h3 id="occurrence"><a href="#occurrence" aria-hidden="true" class="header-anchor">#</a> Occurrence</h3> <p><img src="/specify-icon-18px.png" alt=""> <a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/collectionobject" target="_blank" rel="noopener noreferrer"><strong>Collection Object</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/melisr-docs-vuepress/assets/img/occurrence-2020-10-14-131513.cc1ffdb5.jpg" alt="DwC mapping Occurrence"></p> <h4 id="reproductivecondition"><a href="#reproductivecondition" aria-hidden="true" class="header-anchor">#</a> reproductiveCondition</h4> <p>We map what we call &quot;Phenology&quot; in the herbarium community to
<code>reproductiveCondition</code> in Darwin Core, which is not ideal but the best we can
do at the moment. Phenology in the herbarium world is mainly the presence of
certain reproductive structures on specimens. We use five fields in the
<a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/collectionobject" target="_blank" rel="noopener noreferrer"><strong>Collection Object Attribute</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
table to record a selection of terms from the
<a href="https://hiscom.github.io/hispid/vocabulary/reproductive_condition.xml" target="_blank" rel="noopener noreferrer">HISPID vocabulary<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:
flowers, fruit, buds, fertile and sterile. These values need to be concatenated
into a string.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>dwc_reproductive_condition<span class="token punctuation">`</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>dwc_reproductive_condition<span class="token punctuation">`</span><span class="token punctuation">(</span>in_collection_object_id <span class="token keyword">INT</span><span class="token punctuation">)</span> 
<span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
	<span class="token keyword">declare</span> var_flower <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> var_fruit <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> var_buds <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> var_fertile <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">declare</span> var_sterile <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">declare</span> out_reproductive_condition <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token keyword">SELECT</span> coa<span class="token punctuation">.</span>Text13<span class="token punctuation">,</span> coa<span class="token punctuation">.</span>Text14<span class="token punctuation">,</span> coa<span class="token punctuation">.</span>Text15<span class="token punctuation">,</span> coa<span class="token punctuation">.</span>Text17<span class="token punctuation">,</span> coa<span class="token punctuation">.</span>Text18
    <span class="token keyword">INTO</span> var_flower<span class="token punctuation">,</span> var_fruit<span class="token punctuation">,</span> var_buds<span class="token punctuation">,</span> var_fertile<span class="token punctuation">,</span> var_sterile
	<span class="token keyword">FROM</span> collectionobjectattribute coa
	<span class="token keyword">JOIN</span> collectionobject co <span class="token keyword">ON</span> coa<span class="token punctuation">.</span>CollectionObjectAttributeID<span class="token operator">=</span>co<span class="token punctuation">.</span>CollectionObjectAttributeID
    <span class="token keyword">WHERE</span> co<span class="token punctuation">.</span>CollectionObjectID<span class="token operator">=</span>in_collection_object_id<span class="token punctuation">;</span>
    
    <span class="token keyword">SET</span> out_reproductive_condition<span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> var_flower<span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">OR</span> var_fruit<span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">OR</span> var_buds<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span>
        <span class="token keyword">IF</span> var_flower<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span>
            <span class="token keyword">SET</span> out_reproductive_condition<span class="token operator">=</span><span class="token string">'flowers'</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">IF</span> var_fruit<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span>
			<span class="token keyword">IF</span> out_reproductive_condition <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
                <span class="token keyword">SET</span> out_reproductive_condition <span class="token operator">=</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> out_reproductive_condition<span class="token punctuation">,</span> <span class="token string">'fruit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">ELSE</span> 
				<span class="token keyword">SET</span> out_reproductive_condition <span class="token operator">=</span> <span class="token string">'fruit'</span><span class="token punctuation">;</span>
            <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">IF</span> var_buds<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span>
			<span class="token keyword">IF</span> out_reproductive_condition <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
                <span class="token keyword">SET</span> out_reproductive_condition <span class="token operator">=</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">,</span> out_reproductive_condition<span class="token punctuation">,</span> <span class="token string">'buds'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">ELSE</span> 
				<span class="token keyword">SET</span> out_reproductive_condition <span class="token operator">=</span> <span class="token string">'buds'</span><span class="token punctuation">;</span>
            <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSEIF</span> var_fertile<span class="token operator">=</span><span class="token string">'1'</span> <span class="token operator">OR</span> var_sterile<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span> 
		<span class="token keyword">IF</span> var_fertile<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span>
			<span class="token keyword">SET</span> out_reproductive_condition<span class="token operator">=</span><span class="token string">'fertile'</span><span class="token punctuation">;</span>
		<span class="token keyword">ELSEIF</span> var_sterile<span class="token operator">=</span><span class="token string">'1'</span> <span class="token keyword">THEN</span>
			<span class="token keyword">SET</span> out_reproductive_condition<span class="token operator">=</span><span class="token string">'sterile'</span><span class="token punctuation">;</span>
		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    
<span class="token keyword">RETURN</span> out_reproductive_condition<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>The resulting value is stored in the <code>Text28</code> field in the <strong>Collection Object
Attribute</strong> table.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>update_dwc_reproductive_condition<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>update_dwc_reproductive_condition<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">UPDATE</span> collectionobjectattribute coa
    <span class="token keyword">JOIN</span> collectionobject co <span class="token keyword">ON</span> coa<span class="token punctuation">.</span>CollectionObjectAttributeID<span class="token operator">=</span>co<span class="token punctuation">.</span>CollectionObjectAttributeID
    <span class="token keyword">SET</span> coa<span class="token punctuation">.</span>Text28<span class="token operator">=</span>dwc_reproductive_condition<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="establishmentmeans"><a href="#establishmentmeans" aria-hidden="true" class="header-anchor">#</a> establishmentMeans</h4> <p>We still record what is called <code>establishmentMeans</code> in Darwin Core in the way
HISPID used to recommend and have two fields, <strong>Introduced status</strong> (<code>Text11</code>)
and <strong>Cultivated status</strong> (<code>Text13</code>), in the
<a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/collectingeventattribute" target="_blank" rel="noopener noreferrer"><strong>Collecting Event Attribute</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
table. We should probably adopt the Darwin Core recommendation, as that is what
we do in our flora, but for now we need to convert the content of the two fields
we have to the correct Darwin Core <code>establishmentMeans</code> values. The following
function does just that:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>dwc_establishment_means<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>dwc_establishment_means<span class="token punctuation">`</span><span class="token punctuation">(</span>in_collection_object_id <span class="token keyword">INT</span><span class="token punctuation">)</span> 
<span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> var_introduced <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_cultivated <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> out_establishment_means <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">SELECT</span> cea<span class="token punctuation">.</span>text11<span class="token punctuation">,</span> cea<span class="token punctuation">.</span>text13
    <span class="token keyword">INTO</span> var_introduced<span class="token punctuation">,</span> var_cultivated
    <span class="token keyword">FROM</span> collectionobject co
    <span class="token keyword">JOIN</span> collectingevent ce <span class="token keyword">ON</span> co<span class="token punctuation">.</span> CollectingEventID<span class="token operator">=</span>ce<span class="token punctuation">.</span>CollectingEventID
    <span class="token keyword">JOIN</span> collectingeventattribute cea <span class="token keyword">ON</span> ce<span class="token punctuation">.</span>CollectingEventAttributeID<span class="token operator">=</span>cea<span class="token punctuation">.</span>CollectingEventAttributeID
    <span class="token keyword">WHERE</span> co<span class="token punctuation">.</span>CollectionObjectID<span class="token operator">=</span>in_collection_object_id<span class="token punctuation">;</span>
    
    <span class="token keyword">SET</span> out_establishment_means <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> var_introduced <span class="token operator">=</span> <span class="token string">'Native'</span> <span class="token keyword">THEN</span>
        <span class="token keyword">SET</span> out_establishment_means <span class="token operator">=</span> <span class="token string">'native'</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span>
        <span class="token keyword">IF</span> var_introduced <span class="token operator">=</span> <span class="token string">'Not native'</span> <span class="token keyword">THEN</span>
            <span class="token keyword">SET</span> out_establishment_means <span class="token operator">=</span> <span class="token string">'introduced'</span><span class="token punctuation">;</span>
		<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    
    <span class="token keyword">IF</span> var_cultivated<span class="token operator">=</span><span class="token string">'Cultivated'</span> <span class="token keyword">THEN</span>
        <span class="token keyword">SET</span> out_establishment_means <span class="token operator">=</span> <span class="token string">'cultivated'</span><span class="token punctuation">;</span>
	<span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    
<span class="token keyword">RETURN</span> out_establishment_means<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>The resulting value is stored in <code>Text7</code> in the <strong>Collecting Event Attribute</strong>
table.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>update_dwc_establishment_means<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>update_dwc_establishment_means<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">UPDATE</span> collectingeventattribute cea
    <span class="token keyword">JOIN</span> collectingevent ce <span class="token keyword">ON</span> cea<span class="token punctuation">.</span>CollectingEventAttributeID<span class="token operator">=</span>ce<span class="token punctuation">.</span>CollectingEventAttributeID
    <span class="token keyword">JOIN</span> collectionobject co <span class="token keyword">ON</span> ce<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>co<span class="token punctuation">.</span>CollectingEventID
    <span class="token keyword">SET</span> cea<span class="token punctuation">.</span>Text7<span class="token operator">=</span><span class="token boolean">NULL</span>
    <span class="token keyword">WHERE</span> co<span class="token punctuation">.</span>CollectionID<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>

    <span class="token keyword">UPDATE</span> collectingeventattribute cea
    <span class="token keyword">JOIN</span> collectingevent ce <span class="token keyword">ON</span> cea<span class="token punctuation">.</span>CollectingEventAttributeID<span class="token operator">=</span>ce<span class="token punctuation">.</span>CollectingEventAttributeID
    <span class="token keyword">JOIN</span> collectionobject co <span class="token keyword">ON</span> ce<span class="token punctuation">.</span>CollectingEventID<span class="token operator">=</span>co<span class="token punctuation">.</span>CollectingEventID
    <span class="token keyword">SET</span> cea<span class="token punctuation">.</span>Text7<span class="token operator">=</span>dwc_establishment_means<span class="token punctuation">(</span>co<span class="token punctuation">.</span>CollectionObjectID<span class="token punctuation">)</span>
    <span class="token keyword">WHERE</span> co<span class="token punctuation">.</span>CollectionID<span class="token operator">=</span><span class="token number">4</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>cea<span class="token punctuation">.</span>Text11 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> cea<span class="token punctuation">.</span>Text13 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="event"><a href="#event" aria-hidden="true" class="header-anchor">#</a> Event</h3> <p><img src="/specify-icon-18px.png" alt=""> <a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/collectingevent" target="_blank" rel="noopener noreferrer"><strong>Collecting Event</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/melisr-docs-vuepress/assets/img/event-2020-10-21-104508.4325590a.jpg" alt="DwC mapping Event"></p> <p>No pre-processing is necessary for any of the properties of the <strong>Event</strong> class.
I concatenate <code>eventDateStart</code> and <code>eventDateEnd</code> into <code>eventDate</code>, fix up
<code>eventDate</code> for incomplete dates and add <code>startDayOfYear</code> in post-processing.</p> <h3 id="location"><a href="#location" aria-hidden="true" class="header-anchor">#</a> Location</h3> <p><img src="/specify-icon-18px.png" alt=""> <a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/locality" target="_blank" rel="noopener noreferrer"><strong>Locality</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/melisr-docs-vuepress/assets/img/location-2020-10-14-133141.d95ebf51.jpg" alt="DwC mapping Location"></p> <h4 id="countrycode"><a href="#countrycode" aria-hidden="true" class="header-anchor">#</a> countryCode</h4> <p>The Specify <strong>Geography</strong> table has a <code>GeographyCode</code> column that has the
<code>countryCode</code> filled in for countries, but has different values or no value for
administrative areas within a country. Therefore, if you map the Specify
<code>GeographyCode</code> to the Darwin Core <code>countryCode</code>, you will end up with mostly
<em>NULL</em> values.</p> <p>The following function obtains the <code>countryCode</code> for administrative areas within
countries:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>dwc_countrycode<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>dwc_countrycode<span class="token punctuation">`</span> <span class="token punctuation">(</span>in_geography_id <span class="token keyword">INTEGER</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> var_node_number <span class="token keyword">INTEGER</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_country_code <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">SELECT</span> NodeNumber
    <span class="token keyword">INTO</span> var_node_number
    <span class="token keyword">FROM</span> geography
    <span class="token keyword">WHERE</span> GeographyID<span class="token operator">=</span>in_geography_id<span class="token punctuation">;</span>
    
    <span class="token keyword">SELECT</span> GeographyCode
    <span class="token keyword">INTO</span> var_country_code
    <span class="token keyword">FROM</span> geography
    <span class="token keyword">WHERE</span> NodeNumber<span class="token operator">&lt;=</span>var_node_number <span class="token operator">AND</span> HighestChildNodeNumber<span class="token operator">&gt;=</span>var_node_number <span class="token operator">AND</span> RankID<span class="token operator">=</span><span class="token number">200</span>
    <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">RETURN</span> var_country_code<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>And this procedure stores the value in <code>Text1</code> in the <strong>Geography</strong> table:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>update_dwc_countrycode<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>update_dwc_countrycode<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">UPDATE</span> geography
    <span class="token keyword">SET</span> Text1<span class="token operator">=</span>dwc_countrycode<span class="token punctuation">(</span>GeographyID<span class="token punctuation">)</span>
    <span class="token keyword">WHERE</span> GeographyTreeDefID<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> RankID<span class="token operator">&gt;=</span><span class="token number">200</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>This has to be done only once and after that can be manually filled in when new
areas are added to the database (a very infrequent event for us).</p> <h4 id="minimumelevationinmeters-maximumelevationinmeters-verbatimelevation"><a href="#minimumelevationinmeters-maximumelevationinmeters-verbatimelevation" aria-hidden="true" class="header-anchor">#</a> minimumElevationInMeters, maximumElevationInMeters, verbatimElevation</h4> <p>In Specify you can store altitude in different units and we make use use of
that, as we have many historical collections with altitudes given in feet, so we
have altitudes in metres and feet. Darwin Core only accepts altitude in metres,
so we have to convert the ones in feet. We want to deliver the original values
in feet as <code>verbatimElevation</code>, but do not want to overwrite the verbatim
altitudes we already have. Therefore, we need fields for
<code>minimumElevationInMeters</code>, <code>maximumElevationInMeters</code> and <code>verbatimElevation</code>.
I have put them in <code>Number1</code>, <code>Number2</code> and <code>Text3</code> in the
<a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/locality" target="_blank" rel="noopener noreferrer"><strong>Locality Detail</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
table.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>update_dwc_elevation_terms<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>update_dwc_elevation_terms<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>

    <span class="token keyword">UPDATE</span> locality l
    <span class="token keyword">JOIN</span> localitydetail ld <span class="token keyword">ON</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>ld<span class="token punctuation">.</span>LocalityID
    <span class="token keyword">SET</span> 
      ld<span class="token punctuation">.</span>Number1 <span class="token operator">=</span> <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MinElevation <span class="token keyword">END</span><span class="token punctuation">,</span>
      ld<span class="token punctuation">.</span>Number2 <span class="token operator">=</span> <span class="token keyword">CASE</span> 
        <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>MaxElevation <span class="token operator">Is</span> <span class="token boolean">Null</span> <span class="token keyword">THEN</span>
              <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MinElevation <span class="token keyword">END</span>
            <span class="token keyword">ELSE</span> 
              <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MaxElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MaxElevation <span class="token keyword">END</span>
      <span class="token keyword">END</span><span class="token punctuation">,</span>
      ld<span class="token punctuation">.</span>Text3 <span class="token operator">=</span> <span class="token keyword">CASE</span> 
        <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>VerbatimElevation <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> l<span class="token punctuation">.</span>VerbatimElevation
        <span class="token keyword">ELSE</span>
              <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1
            <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>MaxElevation <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>MinElevation<span class="token punctuation">,</span> l<span class="token punctuation">.</span>Text1<span class="token punctuation">)</span> <span class="token keyword">ELSE</span> CONCAT<span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>MaxElevation<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>Text1<span class="token punctuation">)</span> <span class="token keyword">END</span>
                <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
              <span class="token keyword">END</span>
      <span class="token keyword">END</span>
    <span class="token keyword">WHERE</span> l<span class="token punctuation">.</span>MinElevation <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> localitydetail <span class="token punctuation">(</span>TimestampCreated<span class="token punctuation">,</span> TimestampModified<span class="token punctuation">,</span> Version<span class="token punctuation">,</span> CreatedByAgentID<span class="token punctuation">,</span> LocalityID<span class="token punctuation">,</span> Number1<span class="token punctuation">,</span> Number2<span class="token punctuation">,</span> Text3<span class="token punctuation">)</span>
    <span class="token keyword">SELECT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>LocalityID<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MinElevation <span class="token keyword">END</span> <span class="token keyword">as</span> minimumElevationInMeters<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> 
      <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>MaxElevation <span class="token operator">Is</span> <span class="token boolean">Null</span> <span class="token keyword">THEN</span>
        <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MinElevation <span class="token keyword">END</span>
      <span class="token keyword">ELSE</span> 
        <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1 <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> <span class="token function">round</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>MaxElevation <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">ELSE</span> l<span class="token punctuation">.</span>MaxElevation <span class="token keyword">END</span>
      <span class="token keyword">END</span> <span class="token keyword">AS</span> maximumElevationInMeters<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span> 
      <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>VerbatimElevation <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> l<span class="token punctuation">.</span>VerbatimElevation
      <span class="token keyword">ELSE</span>
        <span class="token keyword">CASE</span> l<span class="token punctuation">.</span>Text1
          <span class="token keyword">WHEN</span> <span class="token string">'ft'</span> <span class="token keyword">THEN</span> 
            <span class="token keyword">CASE</span> 
              <span class="token keyword">WHEN</span> l<span class="token punctuation">.</span>MaxElevation <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>MinElevation<span class="token punctuation">,</span> l<span class="token punctuation">.</span>Text1<span class="token punctuation">)</span> 
              <span class="token keyword">ELSE</span> CONCAT<span class="token punctuation">(</span>l<span class="token punctuation">.</span>MinElevation<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>MaxElevation<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> l<span class="token punctuation">.</span>Text1<span class="token punctuation">)</span> 
            <span class="token keyword">END</span>
          <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
        <span class="token keyword">END</span>
    <span class="token keyword">END</span> <span class="token keyword">AS</span> VerbatimElevation
    <span class="token keyword">FROM</span> locality l
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> localitydetail ld <span class="token keyword">ON</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>ld<span class="token punctuation">.</span>LocalityID
    <span class="token keyword">WHERE</span> l<span class="token punctuation">.</span>MinElevation <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> ld<span class="token punctuation">.</span>LocalityDetailID <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">UPDATE</span> locality l
    <span class="token keyword">JOIN</span> localitydetail ld <span class="token keyword">ON</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>ld<span class="token punctuation">.</span>LocalityID
    <span class="token keyword">SET</span> ld<span class="token punctuation">.</span>Number1<span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> ld<span class="token punctuation">.</span>Number2<span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> ld<span class="token punctuation">.</span>Text3<span class="token operator">=</span><span class="token boolean">NULL</span>
    <span class="token keyword">WHERE</span> l<span class="token punctuation">.</span>MinElevation <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> ld<span class="token punctuation">.</span>Number1 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="minimumdepthinmeters-maximumdepthinmeters-verbatimdepth"><a href="#minimumdepthinmeters-maximumdepthinmeters-verbatimdepth" aria-hidden="true" class="header-anchor">#</a> minimumDepthInMeters, maximumDepthInMeters, verbatimDepth</h4> <p>The situation with the depth fields is like that for the altitude fields, only
there is an extra unit, fathoms, and the depth field are already in the
<strong>Locality detail</strong> table, so it is an easier procedure. I have put
<code>minimumDepthInMeters</code>, <code>maximumDepthInMeters</code> and <code>verbatimDepth</code> in <code>Number3</code>,
<code>Number4</code> and <code>Text4</code> respectively.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>update_dwc_depth_terms<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>update_dwc_depth_terms<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>

    <span class="token keyword">UPDATE</span> localitydetail
    <span class="token keyword">SET</span> 
      Number3 <span class="token operator">=</span> <span class="token keyword">CASE</span> StartDepthUnit <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> StartDepth <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">1.8288</span><span class="token punctuation">)</span> <span class="token keyword">END</span><span class="token punctuation">,</span>
      Number4 <span class="token operator">=</span> <span class="token keyword">CASE</span> 
        <span class="token keyword">WHEN</span> EndDepth <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
          <span class="token keyword">CASE</span> StartDepthUnit <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> StartDepth <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>StartDepth <span class="token operator">*</span> <span class="token number">1.8288</span><span class="token punctuation">)</span> <span class="token keyword">END</span>
            <span class="token keyword">ELSE</span>
              <span class="token keyword">CASE</span> StartDepthUnit <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> EndDepth <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>EndDepth <span class="token operator">*</span> <span class="token number">0.3048</span><span class="token punctuation">)</span> <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>EndDepth <span class="token operator">*</span> <span class="token number">1.8288</span><span class="token punctuation">)</span> <span class="token keyword">END</span>
      <span class="token keyword">END</span><span class="token punctuation">,</span>
      Text4 <span class="token operator">=</span> <span class="token keyword">CASE</span> 
        <span class="token keyword">WHEN</span> EndDepth <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
          <span class="token keyword">CASE</span> StartDepthUnit
            <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">' ft'</span><span class="token punctuation">)</span>
            <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">' fathoms'</span><span class="token punctuation">)</span>
                <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
              <span class="token keyword">END</span>
            <span class="token keyword">ELSE</span>
          <span class="token keyword">CASE</span> StartDepthUnit
            <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> EndDepth<span class="token punctuation">,</span> <span class="token string">' ft'</span><span class="token punctuation">)</span>
            <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> CONCAT<span class="token punctuation">(</span>StartDepth<span class="token punctuation">,</span> <span class="token string">'–'</span><span class="token punctuation">,</span> ENDDepth<span class="token punctuation">,</span> <span class="token string">' fathoms'</span><span class="token punctuation">)</span>
                <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
              <span class="token keyword">END</span>
      <span class="token keyword">END</span>
    <span class="token keyword">WHERE</span> StartDepth <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">UPDATE</span> localitydetail
    <span class="token keyword">SET</span> Number3<span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> Number4<span class="token operator">=</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> Text4<span class="token operator">=</span><span class="token boolean">null</span>
    <span class="token keyword">WHERE</span> StartDepth <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> Number3 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="geo-reference"><a href="#geo-reference" aria-hidden="true" class="header-anchor">#</a> Geo-reference</h3> <p><img src="/specify-icon-18px.png" alt=""> <a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/geocoorddetail" target="_blank" rel="noopener noreferrer"><strong>Geo-coord. Detail</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/melisr-docs-vuepress/assets/img/georeference-2020-10-14-133324.88bc41b3.jpg" alt="DwC mapping georeference"></p> <p>Geo-reference data is in the <strong>Location</strong> class in Darwin Core, but the class
has too many properties to fit in a single screenshot and Specify has a separate
table for at least some of the geo-reference related properties.</p> <h4 id="coordinateuncertaintyinmeters"><a href="#coordinateuncertaintyinmeters" aria-hidden="true" class="header-anchor">#</a> coordinateUncertaintyInMeters</h4> <p>We – and some other Australian herbaria – have traditionally used a – now
seeming rather crude – rank system to record coordinate uncertainty:</p> <ul><li>1: &lt; 50 m</li> <li>2: 50–1000 m</li> <li>3: 1000–10000 m</li> <li>4: 10000–25000 m</li> <li>5: &gt; 25000 m.</li></ul> <p>For modern collections (as in specimens) it is possible to get much more accurate
uncertainties. We have not quite worked out how to do that well, but we already
have the values that GeoLocate stores in the <code>MaxUncertaintyEst</code> fields that we
would like to deliver in preference to what we have been delivering before (the
upper limit of the classes mentioned above).</p> <p>The following function returns the upper limit of the given uncertainty class:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>coordinate_uncertainty_in_meters<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>coordinate_uncertainty_in_meters<span class="token punctuation">`</span><span class="token punctuation">(</span>in_precision <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">RETURNS</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> out_uncertainty <span class="token keyword">INTEGER</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> out_uncertainty <span class="token operator">=</span> <span class="token keyword">CASE</span> in_precision
      <span class="token keyword">WHEN</span> <span class="token string">'1'</span> <span class="token keyword">THEN</span> <span class="token number">50</span>
      <span class="token keyword">WHEN</span> <span class="token string">'2'</span> <span class="token keyword">THEN</span> <span class="token number">1000</span>
      <span class="token keyword">WHEN</span> <span class="token string">'3'</span> <span class="token keyword">THEN</span> <span class="token number">10000</span>
      <span class="token keyword">WHEN</span> <span class="token string">'4'</span> <span class="token keyword">THEN</span> <span class="token number">25000</span>
      <span class="token keyword">ELSE</span> <span class="token boolean">NULL</span>
	<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> out_uncertainty<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>Specify has a <code>GeoRefAccuracy</code> field, which I think fits the bill. The following
procedure will store the value of <code>MaxUncertaintyEst</code> if it's there and
otherwise the returned value of the function above in that field. As the
<strong>Uncertainty</strong> (<code>OriginalElevationUnit</code>) field is in the <strong>Locality</strong> table and
we will have it for locality records that do not yet have a <strong>Geo-coord.
Detail</strong> record, new <strong>Geo-coord. Detail</strong> records will need to be created for
those records.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">procedure</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>update_coordinate_uncertainty_in_meters<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$

<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">`</span>update_coordinate_uncertainty_in_meters<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span> 

	<span class="token keyword">UPDATE</span> locality l
	<span class="token keyword">JOIN</span> geocoorddetail gc <span class="token keyword">ON</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>gc<span class="token punctuation">.</span>LocalityID
	<span class="token keyword">SET</span> gc<span class="token punctuation">.</span>GeoRefAccuracy<span class="token operator">=</span><span class="token keyword">if</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>MaxUncertaintyEst <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token function">ROUND</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>MaxUncertaintyEst<span class="token punctuation">)</span><span class="token punctuation">,</span> coordinate_uncertainty_in_meters<span class="token punctuation">(</span>l<span class="token punctuation">.</span>OriginalElevationUnit<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>OriginalElevationUnit <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">OR</span> gc<span class="token punctuation">.</span>MaxUncertaintyEst <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>Latitude1 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> l<span class="token punctuation">.</span>Longitude1 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> geocoorddetail <span class="token punctuation">(</span>TimestampCreated<span class="token punctuation">,</span> TimestampModified<span class="token punctuation">,</span> Version<span class="token punctuation">,</span> CreatedByAgentID<span class="token punctuation">,</span> GeoRefAccuracy<span class="token punctuation">)</span>
	<span class="token keyword">SELECT</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> 
	  coordinate_uncertainty_in_meters<span class="token punctuation">(</span>l<span class="token punctuation">.</span>OriginalElevationUnit<span class="token punctuation">)</span> <span class="token keyword">as</span> geoRefAccuracy
	<span class="token keyword">FROM</span> locality l
	<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> geocoorddetail gc <span class="token keyword">ON</span> l<span class="token punctuation">.</span>LocalityID<span class="token operator">=</span>gc<span class="token punctuation">.</span>LocalityID
	<span class="token keyword">WHERE</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>OriginalElevationUnit <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> l<span class="token punctuation">.</span>Latitude1 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> l<span class="token punctuation">.</span>Longitude1 <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token operator">AND</span> gc<span class="token punctuation">.</span>GeoCoordDetailID <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="verbatimcoordinatesystem-and-coordinateprecision"><a href="#verbatimcoordinatesystem-and-coordinateprecision" aria-hidden="true" class="header-anchor">#</a> verbatimCoordinateSystem and coordinatePrecision</h4> <p>I used to derive <code>verbatimCoordinateSystem</code> from the <code>OriginalLatLongUnit</code> field
in the <strong>Locality</strong> table, but, since we started using Specify 7 we have been
finding some incorrect values for <code>OriginalLatLongUnit</code>, so, for the moment,
I infer <code>verbatimCoordinateSystem</code> myself from the <code>Lat1Text</code> and <code>Long1Text</code>
fields. The obtained value is stored in the <code>OriginalCoordSystem</code> field in the
<strong>Geo-coord. Detail</strong> table.</p> <p>Specify does not have <code>coordinatePrecision</code>, so it is calculated from the
<code>Lat1Text</code> and <code>Long1Text</code> fields. ALA has a (rather senseless) data quality
test that fails when the number of decimals of the <code>coordinatePrecision</code> is
different from that of <code>decimalLatitude</code> and <code>decimalLongitude</code>, so we need a
field of type Decimal with 10 digits – because that is what <code>Latitude1</code> and
<code>Longitude1</code> have – to store the value. We are using <code>NamedPlaceExtent</code> in the
<strong>Geo-coord. Detail</strong> table, which fits the bill and was not used before, but it
would be good to have a dedicated field for <code>coordinatePrecision</code>.</p> <p>The Python code below calculates <code>verbatimCoordinateSystem</code> and
<code>coordinatePrecision</code>. As for the calculation of both terms <code>Lat1Text</code> and
<code>Long1Text</code> need to be parsed into degrees, minutes and seconds, which takes up
about half of the code, the two terms are taken together here.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> re

<span class="token keyword">def</span> <span class="token function">verbatim_coord_system</span><span class="token punctuation">(</span>lattext<span class="token punctuation">,</span> lngtext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    verbatim_coordinate_system <span class="token operator">=</span> <span class="token boolean">None</span>
    lat_deg<span class="token punctuation">,</span> lat_min<span class="token punctuation">,</span> lat_sec<span class="token punctuation">,</span> lng_deg<span class="token punctuation">,</span> lng_min<span class="token punctuation">,</span> lng_sec <span class="token operator">=</span> parse_latlng_text<span class="token punctuation">(</span>lattext<span class="token punctuation">,</span> lngtext<span class="token punctuation">)</span>
            
    <span class="token keyword">if</span> lat_sec <span class="token keyword">or</span> lng_sec<span class="token punctuation">:</span>
        verbatim_coordinate_system <span class="token operator">=</span> <span class="token string">'degrees minutes decimal seconds'</span>
    <span class="token keyword">elif</span> lat_min <span class="token keyword">or</span> lng_min<span class="token punctuation">:</span>
        verbatim_coordinate_system <span class="token operator">=</span> <span class="token string">'degrees decimal minutes'</span>
    <span class="token keyword">elif</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lat_deg<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lng_deg<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span>
        verbatim_coordinate_system <span class="token operator">=</span> <span class="token string">'decimal degrees'</span>
        
    <span class="token keyword">return</span> verbatim_coordinate_system

<span class="token keyword">def</span> <span class="token function">coordinate_precision</span><span class="token punctuation">(</span>lattext<span class="token punctuation">,</span> lngtext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    coordinate_precision <span class="token operator">=</span> <span class="token boolean">None</span>
    lat_deg<span class="token punctuation">,</span> lat_min<span class="token punctuation">,</span> lat_sec<span class="token punctuation">,</span> lng_deg<span class="token punctuation">,</span> lng_min<span class="token punctuation">,</span> lng_sec <span class="token operator">=</span> parse_latlng_text<span class="token punctuation">(</span>lattext<span class="token punctuation">,</span> lngtext<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> lat_sec <span class="token keyword">and</span> lng_sec<span class="token punctuation">:</span>
        coordinate_precision <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> decimal_precision_latlng<span class="token punctuation">(</span>lat_sec<span class="token punctuation">,</span> lng_sec<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> lat_min <span class="token keyword">and</span> lng_min<span class="token punctuation">:</span>
        coordinate_precision <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> decimal_precision_latlng<span class="token punctuation">(</span>lat_min<span class="token punctuation">,</span> lng_min<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lat_deg<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">or</span> <span class="token builtin">float</span><span class="token punctuation">(</span>lng_deg<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">:</span>
        coordinate_precision <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> decimal_precision_latlng<span class="token punctuation">(</span>lat_deg<span class="token punctuation">,</span> lng_deg<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> coordinate_precision

<span class="token keyword">def</span> <span class="token function">parse_latlng_text</span><span class="token punctuation">(</span>lattext<span class="token punctuation">,</span> lngtext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lat_pattern <span class="token operator">=</span> <span class="token string">r&quot;^([-+]?\d*\.?\d*)?[d°]? ?(\d*\.?\d*)?'? ?(\d*\.?\d*)?\&quot;? ?([NS]{1})?$&quot;</span>
    lng_pattern <span class="token operator">=</span> <span class="token string">r&quot;^([-+]?\d*\.?\d*)?[d°]? ?(\d*\.?\d*)?'? ?(\d*\.?\d*)?\&quot;? ?([EW]{1})?$&quot;</span>
    
    lat_deg <span class="token operator">=</span> <span class="token boolean">None</span>
    lat_min <span class="token operator">=</span> <span class="token boolean">None</span>
    lat_sec <span class="token operator">=</span> <span class="token boolean">None</span>
    lng_deg <span class="token operator">=</span> <span class="token boolean">None</span>
    lng_min <span class="token operator">=</span> <span class="token boolean">None</span>
    lng_sec <span class="token operator">=</span> <span class="token boolean">None</span>
    
    lat_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>lat_pattern<span class="token punctuation">,</span> lattext<span class="token punctuation">)</span>
    <span class="token keyword">if</span> lat_match<span class="token punctuation">:</span>
        lat_deg <span class="token operator">=</span> lat_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        lat_min <span class="token operator">=</span> lat_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        lat_sec <span class="token operator">=</span> lat_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    lng_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>lng_pattern<span class="token punctuation">,</span> lngtext<span class="token punctuation">)</span>
    <span class="token keyword">if</span> lng_match<span class="token punctuation">:</span>
        lng_deg <span class="token operator">=</span> lng_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        lng_min <span class="token operator">=</span> lng_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        lng_sec <span class="token operator">=</span> lng_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>lat_deg<span class="token punctuation">,</span> lat_min<span class="token punctuation">,</span> lat_sec<span class="token punctuation">,</span> lng_deg<span class="token punctuation">,</span> lng_min<span class="token punctuation">,</span> lng_sec<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">decimal_precision_latlng</span><span class="token punctuation">(</span>lat<span class="token punctuation">,</span> lng<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dp_lat <span class="token operator">=</span> decimal_precision<span class="token punctuation">(</span>lat<span class="token punctuation">)</span>
    dp_lng <span class="token operator">=</span> decimal_precision<span class="token punctuation">(</span>lng<span class="token punctuation">)</span>
    <span class="token keyword">return</span> dp_lat <span class="token keyword">if</span> dp_lat <span class="token operator">&lt;</span> dp_lng <span class="token keyword">else</span> dp_lng
        
<span class="token keyword">def</span> <span class="token function">decimal_precision</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token string">'.'</span> <span class="token keyword">in</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">10</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">str</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
</code></pre></div><h3 id="identification"><a href="#identification" aria-hidden="true" class="header-anchor">#</a> Identification</h3> <p><img src="/specify-icon-18px.png" alt=""> <a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/determination" target="_blank" rel="noopener noreferrer"><strong>Determination</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/melisr-docs-vuepress/assets/img/identification-2020-10-14-133512.05ea401e.jpg" alt="DwC mapping Identification"></p> <h4 id="identificationqualifier"><a href="#identificationqualifier" aria-hidden="true" class="header-anchor">#</a> identificationQualifier</h4> <p>Specify has the <code>Qualifier</code>, <code>SubSpQualifier</code> and <code>VarQualifier</code> fields to deal
with uncertain determinations. In our implementation we just use the <code>Qualifier</code>
field and have a pick list field for the rank that the qualifier applies to on
the <code>VarQualifier</code> field.</p> <p>The Darwin Core <a href="https://dwc.tdwg.org/terms/#dwc:identificationQualifier" target="_blank" rel="noopener noreferrer"><code>identificationQualifier</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
is a string that contains the qualifier and all parts of the name that come
after it. We use the following function to create the Darwin Core
<code>identificationQualifier</code> string from the data in our database:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token comment">/*
* Function creates the Darwin Core identificationQualifier string from elements
* in the Determination and Taxon tables. The DwC identificationQualifier is the 
* qualifier plus the part of the scientific name that follows it.
*/</span>
<span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>dwc_identification_qualifier<span class="token punctuation">`</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>dwc_identification_qualifier<span class="token punctuation">`</span> <span class="token punctuation">(</span>in_qualifier <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_rank <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in_taxonID <span class="token keyword">INT</span><span class="token punctuation">)</span> 
    <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> var_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_rank_id <span class="token keyword">INT</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> num <span class="token keyword">INT</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> ins <span class="token keyword">INT</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> spacer <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">SELECT</span> t<span class="token punctuation">.</span>RankID<span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName
    <span class="token keyword">INTO</span> var_rank_id<span class="token punctuation">,</span> var_name
    <span class="token keyword">FROM</span> taxon t
    <span class="token keyword">WHERE</span> t<span class="token punctuation">.</span>TaxonID<span class="token operator">=</span>in_taxonID<span class="token punctuation">;</span>

    <span class="token keyword">IF</span> in_qualifier <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
        <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">ELSE</span>
        <span class="token comment">-- number of name elements</span>
        <span class="token keyword">CASE</span> 
            <span class="token keyword">WHEN</span> var_rank_id <span class="token operator">&lt;</span> <span class="token number">220</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">-- genus or monomial</span>
            <span class="token keyword">WHEN</span> var_rank_id <span class="token operator">=</span> <span class="token number">220</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> num <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">-- species</span>
            <span class="token keyword">WHEN</span> var_rank_id <span class="token operator">&gt;</span> <span class="token number">220</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> num <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">-- infraspecific taxon</span>
        <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>

        <span class="token comment">-- qualifier insertion point</span>
        <span class="token keyword">CASE</span> in_rank
            <span class="token keyword">WHEN</span> <span class="token string">'family'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">-- preceding name</span>
            <span class="token keyword">WHEN</span> <span class="token string">'genus'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>      <span class="token comment">--    ,,</span>
            <span class="token keyword">WHEN</span> <span class="token string">'species'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">-- preceding first epithet</span>
            <span class="token keyword">WHEN</span> <span class="token string">'subspecies'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">-- preceding second epithet</span>
            <span class="token keyword">WHEN</span> <span class="token string">'variety'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token comment">--    ,,</span>
            <span class="token keyword">WHEN</span> <span class="token string">'forma'</span> <span class="token keyword">THEN</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>      <span class="token comment">--    ,,</span>
            <span class="token keyword">ELSE</span> <span class="token keyword">SET</span> ins <span class="token operator">=</span> num<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>

        <span class="token comment">-- by default the qualifier is inserted before the last name element </span>
        <span class="token keyword">IF</span> ins <span class="token operator">&gt;</span> num <span class="token keyword">THEN</span> 
            <span class="token keyword">SET</span> ins <span class="token operator">=</span> num<span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

        <span class="token keyword">IF</span> in_qualifier<span class="token operator">=</span><span class="token string">'?'</span> <span class="token keyword">THEN</span>
            <span class="token keyword">SET</span> spacer<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">ELSE</span>
            <span class="token keyword">SET</span> spacer<span class="token operator">=</span><span class="token string">' '</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

        <span class="token comment">-- return dwc:identificationQualifier</span>
        <span class="token keyword">CASE</span> ins
            <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span>
                <span class="token keyword">RETURN</span> CONCAT<span class="token punctuation">(</span>in_qualifier<span class="token punctuation">,</span> spacer<span class="token punctuation">,</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token keyword">THEN</span>
                <span class="token keyword">RETURN</span> CONCAT<span class="token punctuation">(</span>in_qualifier<span class="token punctuation">,</span> spacer<span class="token punctuation">,</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">WHEN</span> <span class="token number">3</span> <span class="token keyword">THEN</span>
                <span class="token keyword">RETURN</span> CONCAT<span class="token punctuation">(</span>in_qualifier<span class="token punctuation">,</span> spacer<span class="token punctuation">,</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> split_string<span class="token punctuation">(</span>var_name<span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">CASE</span><span class="token punctuation">;</span>
        
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

<span class="token keyword">END</span> $$
<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token comment">/*
* Function splits the input string (str) on a delimiter (del) and returns the
* bit indicated by the third parameter (i).
* http://stackoverflow.com/questions/14950466/how-to-split-the-name-string-in-mysql#answer-26491403
*/</span>
<span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>split_string<span class="token punctuation">`</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>split_string<span class="token punctuation">`</span><span class="token punctuation">(</span>str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> del <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> i <span class="token keyword">INT</span><span class="token punctuation">)</span> 
    <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> n <span class="token keyword">INT</span> <span class="token punctuation">;</span>
    <span class="token keyword">SET</span> n <span class="token operator">=</span> LENGTH<span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">-</span> LENGTH<span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> del<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> i <span class="token operator">&gt;</span> n <span class="token keyword">THEN</span>
        <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">ELSE</span>
        <span class="token keyword">RETURN</span> SUBSTRING_INDEX<span class="token punctuation">(</span>SUBSTRING_INDEX<span class="token punctuation">(</span>str<span class="token punctuation">,</span> del<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">,</span> del <span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>The value that is returned by this function is stored in the <code>Text1</code> field:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> update_dwc_identification_qualifier $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_dwc_identification_qualifier <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">UPDATE</span> determination
    <span class="token keyword">SET</span> Text1<span class="token operator">=</span>dwc_identification_qualifier<span class="token punctuation">(</span>Qualifier<span class="token punctuation">,</span> VarQualifier<span class="token punctuation">,</span> TaxonID<span class="token punctuation">)</span>
    <span class="token keyword">WHERE</span> Qualifier <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> TaxonID <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="typestatus"><a href="#typestatus" aria-hidden="true" class="header-anchor">#</a> typeStatus</h4> <p>Specify deals with nomenclatural type designations as determinations, so so do
we. We have a determination type – in the <code>FeatureOrBasis</code> field – 'Type
status' to indicate that a determination is really a nomenclatural type status
designation. As, in our implementation, 'Type status' determinations are never
current determinations, they will be excluded from the Darwin Core Occurrence
Core mapping, because in the query underlying the mapping <code>Is Current</code> will be
set to 'Yes'. Also, the Darwin Core <code>typeStatus</code> is different from the Specify
<code>Type Status</code> in that, apart from the type of type, it also contains the
typified name and, optionally, other information. Therefore we store the Darwin
Core <code>typeStatus</code> in a field in the <strong>Collection Object</strong> table.</p> <p>The following function compiles the Darwin Core <code>typeStatus</code> string:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token comment">/*
* Function checks if a collection object is a type and, if so, concatenates the
* Darwin Core typeStatus string from values of fields in the Determination and 
* Taxon tables. 
*/</span>
<span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>dwc_type_status<span class="token punctuation">`</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>dwc_type_status<span class="token punctuation">`</span> <span class="token punctuation">(</span>colobjid <span class="token keyword">INT</span><span class="token punctuation">)</span> 
<span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> var_typeOfType <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_scientificName <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_author <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_protologue <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">DECLARE</span> var_year <span class="token keyword">INT</span><span class="token punctuation">;</span>

    <span class="token keyword">DECLARE</span> str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">SELECT</span> d<span class="token punctuation">.</span>TypeStatusName<span class="token punctuation">,</span> t<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Author<span class="token punctuation">,</span> t<span class="token punctuation">.</span>CommonName<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Number2
    <span class="token keyword">INTO</span> var_typeOfType<span class="token punctuation">,</span> var_scientificName<span class="token punctuation">,</span> var_author<span class="token punctuation">,</span> var_protologue<span class="token punctuation">,</span> var_year
    <span class="token keyword">FROM</span> determination d
    <span class="token keyword">JOIN</span> taxon t <span class="token keyword">ON</span> d<span class="token punctuation">.</span>TaxonID<span class="token operator">=</span>t<span class="token punctuation">.</span>TaxonID
    <span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>CollectionObjectID<span class="token operator">=</span>colobjid <span class="token operator">AND</span> d<span class="token punctuation">.</span>TypeStatusName <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> d<span class="token punctuation">.</span>YesNo1<span class="token operator">=</span><span class="token number">1</span>
        <span class="token comment">-- exclude type status designations with qualifiers and authentic specimens</span>
        <span class="token comment">-- for invalid names</span>
        <span class="token operator">AND</span> d<span class="token punctuation">.</span>SubspQualifier <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> d<span class="token punctuation">.</span>TypeStatusName<span class="token operator">!=</span><span class="token string">'Authentic specimen'</span>
    <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">IF</span> var_typeOfType <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
        <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">ELSE</span>
        <span class="token keyword">SET</span> str <span class="token operator">=</span> CONCAT_WS<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> var_typeOfType<span class="token punctuation">,</span> <span class="token string">'of'</span><span class="token punctuation">,</span> var_scientificName<span class="token punctuation">,</span> var_author<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">IF</span> var_protologue <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> var_year <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
            <span class="token keyword">SET</span> str <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">', '</span><span class="token punctuation">,</span> var_protologue<span class="token punctuation">,</span> <span class="token string">' ('</span><span class="token punctuation">,</span> var_year<span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
        <span class="token keyword">RETURN</span> str<span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>

<span class="token keyword">END</span> $$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><p>This procedure stores the returned value in the <code>Description</code> field in the
<strong>Collection Object</strong> table:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> update_dwc_type_status $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> update_dwc_type_status <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">UPDATE</span> collectionobject
    <span class="token keyword">SET</span> Description<span class="token operator">=</span>dwc_type_status<span class="token punctuation">(</span>CollectionObjectID<span class="token punctuation">)</span>
    <span class="token keyword">WHERE</span> CollectionObjectID <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> CollectionObjectID
        <span class="token keyword">FROM</span> determination
        <span class="token keyword">WHERE</span> TypeStatusName <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
            <span class="token operator">AND</span> YesNo1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> SubspQualifier <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> TypeStatusName<span class="token operator">!=</span><span class="token string">'Authentic specimen'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">UPDATE</span> collectionobject
    <span class="token keyword">SET</span> Description<span class="token operator">=</span><span class="token boolean">NULL</span>
    <span class="token keyword">WHERE</span> CollectionObjectID <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> CollectionObjectID
        <span class="token keyword">FROM</span> determination
        <span class="token keyword">WHERE</span> TypeStatusName <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
            <span class="token operator">AND</span> YesNo1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> SubspQualifier <span class="token operator">IS</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> TypeStatusName<span class="token operator">!=</span><span class="token string">'Authentic specimen'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h3 id="taxon"><a href="#taxon" aria-hidden="true" class="header-anchor">#</a> Taxon</h3> <p><img src="/specify-icon-18px.png" alt=""> <a href="https://data.rbg.vic.gov.au/specify/specifyschema/table/taxon" target="_blank" rel="noopener noreferrer"><strong>Taxon</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="/melisr-docs-vuepress/assets/img/taxon-2020-10-14-133713.52fc3969.jpg" alt="DwC mapping Taxon"></p> <h4 id="infraspecificepithet"><a href="#infraspecificepithet" aria-hidden="true" class="header-anchor">#</a> infraspecificEpithet</h4> <p>Because we are a herbarium we have to deal with multiple infraspecific ranks.
The Specify query provides subspecies, variety etc., but not a single
infraspecific epithet. So we have to store it somewhere ourselves.</p> <p>We have been doing this for years with a trigger, which I will not show, as the
use of triggers is frowned upon by the Specify Collections Consortium, but it
does something like this:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> taxon <span class="token keyword">SET</span> Text5<span class="token operator">=</span><span class="token string">&quot;Name&quot;</span> <span class="token keyword">WHERE</span> RankID<span class="token operator">&gt;</span><span class="token number">220</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="post-processing"><a href="#post-processing" aria-hidden="true" class="header-anchor">#</a> Post-processing</h2> <p>The following query is used for the <strong>Occurrence Core</strong> in the IPT:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  m<span class="token punctuation">.</span>occurrenceID<span class="token punctuation">,</span>
  
  <span class="token comment">-- Record Level Terms</span>
  <span class="token string">'PhysicalObject'</span> <span class="token keyword">AS</span> <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
  modified<span class="token punctuation">,</span>
  <span class="token string">'https://creativecommons.org/licenses/by/4.0/legalcode'</span> <span class="token keyword">AS</span> license<span class="token punctuation">,</span>
  <span class="token string">'Royal Botanic Gardens Board'</span> <span class="token keyword">AS</span> rightsHolder<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>institutionCode<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>collectionCode<span class="token punctuation">,</span>
  <span class="token string">'PreservedSpecimen'</span> <span class="token keyword">AS</span> basisOfRecord<span class="token punctuation">,</span>
  
  <span class="token comment">-- Occurrence</span>
  m<span class="token punctuation">.</span>catalogNumber<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>occurrenceRemarks<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>recordNumber<span class="token punctuation">,</span>
  <span class="token keyword">replace</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>recordedBy<span class="token punctuation">,</span> <span class="token string">'; '</span><span class="token punctuation">,</span> <span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> recordedBy<span class="token punctuation">,</span>
  ai<span class="token punctuation">.</span>recordedByID<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>reproductiveCondition<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>establishmentMeans<span class="token punctuation">,</span>
  <span class="token string">'present'</span> <span class="token keyword">AS</span> occurrenceStatus<span class="token punctuation">,</span>
  <span class="token keyword">replace</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>preparations<span class="token punctuation">,</span> <span class="token string">'; '</span><span class="token punctuation">,</span> <span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> preparations<span class="token punctuation">,</span>
  <span class="token keyword">replace</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>associatedSequences<span class="token punctuation">,</span> <span class="token string">' | '</span><span class="token punctuation">,</span> <span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> associatedSequences<span class="token punctuation">,</span>
  <span class="token comment">-- associatedTaxa,</span>
  
  <span class="token comment">-- Organism</span>
  <span class="token comment">-- previousIdentifications,</span>
  
  <span class="token comment">-- Event</span>
  m<span class="token punctuation">.</span>eventID<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>parentEventID<span class="token punctuation">,</span>
  CONCAT_WS<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> ipt_iso_date<span class="token punctuation">(</span>m<span class="token punctuation">.</span>eventDateStart<span class="token punctuation">)</span><span class="token operator">/</span>ipt_iso_date<span class="token punctuation">(</span>m<span class="token punctuation">.</span>eventDateEnd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> eventDate<span class="token punctuation">,</span>
  <span class="token keyword">IF</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>eventDateEnd <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> ipt_startDayOfYear<span class="token punctuation">(</span>m<span class="token punctuation">.</span>eventDateStart<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> startDayOfYear<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">year</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
  m<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">month</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
  m<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">day</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>verbatimEventDate<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>habitat<span class="token punctuation">,</span>
  
  <span class="token comment">-- Location</span>
  m<span class="token punctuation">.</span>locationID<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>waterBody<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>islandGroup<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>island<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>country<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>countryCode<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>stateProvince<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>county<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>verbatimLocality <span class="token keyword">AS</span> locality<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>verbatimLocality<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>verbatimElevation<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>minimumElevationInMeters<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>maximumElevationInMeters<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>verbatimDepth<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>minimumDepthInMeters<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>maximumDepthInMeters<span class="token punctuation">,</span>
  <span class="token keyword">IF</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>decimalLatitude <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>verbatimLatitude<span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> verbatimLatitude<span class="token punctuation">,</span>
  <span class="token keyword">IF</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>verbatimLongitude <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>verbatimLongitude<span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> verbatimLongitude<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>verbatimCoordinateSystem<span class="token punctuation">,</span>
  srs_from_datum<span class="token punctuation">(</span>m<span class="token punctuation">.</span>geodeticDatum<span class="token punctuation">)</span> <span class="token keyword">AS</span> verbatimSRS<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>decimalLatitude<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>decimalLongitude<span class="token punctuation">,</span>
  srs_from_datum<span class="token punctuation">(</span>m<span class="token punctuation">.</span>geodeticDatum<span class="token punctuation">)</span> <span class="token keyword">AS</span> geodeticDatum<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>coordinateUncertaintyInMeters<span class="token punctuation">,</span>
  <span class="token function">ROUND</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>coordinatePrecision<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> coordinatePrecision<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>georeferencedBy<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>georeferencedDate<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>georeferenceProtocol<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>georeferenceSources<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>georeferenceVerificationStatus<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>georeferenceRemarks<span class="token punctuation">,</span>
  
  <span class="token comment">-- Identification</span>
  m<span class="token punctuation">.</span>identificationID<span class="token punctuation">,</span>
  <span class="token keyword">replace</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>identifiedBy<span class="token punctuation">,</span> <span class="token string">'; '</span><span class="token punctuation">,</span> <span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> identifiedBy<span class="token punctuation">,</span>
  ai<span class="token punctuation">.</span>identifiedByID<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>dateIdentified<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>identificationRemarks<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>identificationQualifier<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>typeStatus<span class="token punctuation">,</span>
  
  <span class="token comment">-- Taxon</span>
  m<span class="token punctuation">.</span>scientificName<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>kingdom<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>phylum<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>class<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span><span class="token punctuation">`</span><span class="token keyword">order</span><span class="token punctuation">`</span><span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>family<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>genus<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>specificEpithet<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>taxonRank<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>scientificNameAuthorship<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>taxonRemarks<span class="token punctuation">,</span>
  <span class="token string">'ICN'</span> <span class="token keyword">AS</span> nomenclaturalCode<span class="token punctuation">,</span>
  m<span class="token punctuation">.</span>nomenclaturalStatus
  
<span class="token keyword">FROM</span> mel_avh_occurrence_core m
<span class="token keyword">JOIN</span> mel_avh_occurrence_core_agent_id ai <span class="token keyword">ON</span> m<span class="token punctuation">.</span>mel_avh_occurrence_coreId<span class="token operator">=</span>ai<span class="token punctuation">.</span>CollectionObjectID
</code></pre></div><h4 id="default-values"><a href="#default-values" aria-hidden="true" class="header-anchor">#</a> Default values</h4> <p>Many terms have the same value for every record in the data set. Currently, the
ALA ingestion pipeline does not honour the defaults set in the <code>meta.xml</code> file
of the Darwin Core Archive. You can set default values elsewhere, but I prefer
to have everything in the data.</p> <h4 id="aggregated-terms"><a href="#aggregated-terms" aria-hidden="true" class="header-anchor">#</a> Aggregated terms</h4> <p>We prefer to use a semicolon as the separator in aggregated values, but Darwin
Core recommends pipes, so I replace the semicolons with pipes.</p> <h4 id="incomplete-dates"><a href="#incomplete-dates" aria-hidden="true" class="header-anchor">#</a> Incomplete dates</h4> <p>The Specify Data Exporter leaves in the '-00' for incomplete dates, which makes
them invalid ISO dates and makes the IPT throw a tantrum. The following function
strips the '-00' of incomplete dates:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$

<span class="token keyword">DROP</span> <span class="token keyword">FUNCTION</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>ipt_iso_date<span class="token punctuation">`</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>ipt_iso_date<span class="token punctuation">`</span><span class="token punctuation">(</span>in_date <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
  <span class="token keyword">RETURN</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>in_date<span class="token punctuation">,</span> <span class="token string">'-00'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> $$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="eventdate"><a href="#eventdate" aria-hidden="true" class="header-anchor">#</a> eventDate</h4> <p>We concatenate <code>eventDateStart</code> and <code>eventDateEnd</code> with
<code>CONCAT_WS('/', ipt_iso_date(m.eventDateStart, m.eventDateEnd)</code>.</p> <h4 id="startdayofyear"><a href="#startdayofyear" aria-hidden="true" class="header-anchor">#</a> startDayOfYear</h4> <p>I am not sure how useful <code>startDayOfYear</code> is, but I can imagine a use for it in
phenology studies and it is calculated easily enough from the <code>eventDate</code>.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>ipt_startDayOfYear<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>ipt_startDayOfYear<span class="token punctuation">`</span><span class="token punctuation">(</span>in_date <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token keyword">RETURNS</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">DECLARE</span> var_iso_date <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> var_iso_date<span class="token operator">=</span>ipt_iso_date<span class="token punctuation">(</span>in_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">IF</span> LENGTH<span class="token punctuation">(</span>var_iso_date<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">THEN</span>
        <span class="token keyword">RETURN</span> DAYOFYEAR<span class="token punctuation">(</span>var_iso_date<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">ELSE</span>
        <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>  
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="verbatimlatitude-verbatimlongitude"><a href="#verbatimlatitude-verbatimlongitude" aria-hidden="true" class="header-anchor">#</a> verbatimLatitude, verbatimLongitude</h4> <p>Specify often puts '0° S' in <code>Lat1Text</code> when there is no latitude and
longitude, which is harmless, but does not look so good if it ends up in a data
set, so we only deliver a value for <code>verbatimLatitude</code> and <code>verbatimLongitude</code>
if we also have <code>decimalLatitude</code> and <code>decimalLongitude</code>.</p> <h4 id="verbatimsrs-geodeticdatum"><a href="#verbatimsrs-geodeticdatum" aria-hidden="true" class="header-anchor">#</a> verbatimSRS, geodeticDatum</h4> <p>We have datums in our database, but Darwin Core recommends Spatial Reference
System (SRS). You could map the values in the IPT, but then you would have to
verify that the mapping is still there every time you change something in the
IPT and, moreover, you would have to do it twice. So I do it in the query.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">function</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>srs_from_datum<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">USE</span> <span class="token punctuation">`</span>melisr<span class="token punctuation">`</span>$$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> <span class="token punctuation">`</span>srs_from_datum<span class="token punctuation">`</span><span class="token punctuation">(</span>in_datum <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">CHARSET</span> utf8
<span class="token keyword">BEGIN</span>
    <span class="token keyword">DECLARE</span> out_srs <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">SET</span> out_srs <span class="token operator">=</span> <span class="token keyword">CASE</span> in_datum
      <span class="token keyword">WHEN</span> <span class="token string">'WGS84'</span> <span class="token keyword">THEN</span> <span class="token string">'epsg:4326'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'GDA94'</span> <span class="token keyword">THEN</span> <span class="token string">'epsg:4283'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'AGD84'</span> <span class="token keyword">THEN</span> <span class="token string">'epsg:4203'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'AGD66'</span> <span class="token keyword">THEN</span> <span class="token string">'epsg:4202'</span>
      <span class="token keyword">WHEN</span> <span class="token string">'Minna'</span> <span class="token keyword">THEN</span> <span class="token string">'epsg:4263'</span>
      <span class="token keyword">ELSE</span> <span class="token boolean">null</span>
	<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
</code></pre></div><h4 id="coordinateprecision"><a href="#coordinateprecision" aria-hidden="true" class="header-anchor">#</a> coordinatePrecision</h4> <p>While <code>Latitude1</code> and <code>Longitude1</code> are stored with ten decimal places, the
exported values only have seven. Therefore, we round the values of
<code>coordinatePrecision</code> to seven decimal places as well in order to try and pass
the 'Coordinate precision not valid' test in ALA.</p> <h4 id="recordedbyid-identifiedbyid"><a href="#recordedbyid-identifiedbyid" aria-hidden="true" class="header-anchor">#</a> recordedByID, identifiedByID</h4> <p>I will explain later.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/15/2020, 6:07:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/melisr-docs-vuepress/additional-documents/business-case/" class="prev">
          Business case (2009)
        </a></span> <span class="next"><a href="/melisr-docs-vuepress/additional-documents/specify-ipt-integration/">
          Specify IPT integration
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/melisr-docs-vuepress/assets/js/app.ed396d9f.js" defer></script><script src="/melisr-docs-vuepress/assets/js/3.08a0837d.js" defer></script><script src="/melisr-docs-vuepress/assets/js/16.07b41535.js" defer></script>
  </body>
</html>
